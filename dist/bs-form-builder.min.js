/*
 * bsFormBuilder 1.0.7
 * A Form Builder base on JQuery and Bootstrap.
 * https://gitee.com/fuhai/bsFormBuilder
 *
 * Copyright 2022, Michael <fuhai999@gmail.com>
 * Released under the LGPL license.
*/

!function(c){function a(t,e){this.options=c.extend(o,e),this.defaultProps=e.defaultProps||[];for(var n of i)-1===this.defaultProps.map(t=>t.name).indexOf(n.name)&&this.defaultProps.push(n);this.propTemplates=c.extend(r,e.propTemplates),this.useComponents=e.useComponents||[],this.unUseComponents=e.unUseComponents||[],this.$rootEl=c(t),this.$container=null,this.$containerPlaceHolder=null,this.$propsPanel=null,this.components={},this.datas=[],this.currentData=null,this.componentCounter=1,this.optionsCounter=3,this.ajaxCache={},"view"===this.options.mode?this._initViewMode():this._initBuilderMode()}var o={mode:"builder",templateEngine:new Fasty,bsFormContainerSelector:".bsFormContainer",bsFormContainerFilterSelector:".bsFormFilter",bsFormContainerSortableGroup:"shared",bsFormContainerPlaceHolderSelector:".bsFormContainer-placeholder",bsFormPropsSelector:".bsFormProps",bsFormPropsTitleSelector:".bsFormPropsTitle",bsFormPropsFilter:null,bsFormPropsItemAppendBefore:null,bsFormPropsItemAppended:null,customBuilderStructure:!1,onDataChange:null,onDataChanged:null,renderEmptyDrags:null,components:[],componentIdPrefix:"",useComponents:[],unUseComponents:[],customRender:null,optionsDatasources:null,actionButtons:[{text:"导出 JSON",mainClass:"btn-primary",icon:"bi bi-arrow-up pr-1",onclick:function(t,e){var n=e.exportToJson(),e=e._renderTemplate('<div class="modal">  <div class="modal-dialog modal-lg">    <div class="modal-content shadow-lg">      <div class="modal-header">        <h5 class="modal-title">{{title}}</h5>        <button type="button" class="close" data-dismiss="modal" aria-label="Close" >          <span aria-hidden="true">&times;</span>        </button>      </div>      <div class="modal-body" style="word-break: break-all">        <p>{{content}}</p>      </div>      <div class="modal-footer">        <button type="button" class="btn btn-secondary" data-dismiss="modal"> 关闭 </button>      </div>    </div>  </div></div>',["title","content"],["json内容",n]),o=c(e);o.appendTo(c("body")).show(),o.find(".close,.btn").on("click",function(){o.remove()})}},{text:"下载 HTML",mainClass:"btn-primary",icon:"bi bi-arrow-up pr-1",onclick:function(t,e){var e=e.exportToHtml(),n=document.createElement("a");n.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),n.setAttribute("download","bsFormBuilder.html"),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}},{text:"获取源码",mainClass:"btn-primary",icon:"bi bi-eye pr-1",onclick:function(){alert("这里的所有按钮，按钮功能都是可以自定义的~~~"),window.open("https://gitee.com/fuhai/bsFormBuilder")}},{text:"清空",mainClass:"btn-danger",icon:"bi bi-trash pr-1",onclick:function(t,e){e.clear()}}],actionButtonTemplate:'<button type="button" class="btn btn-sm {{mainClass}}" >  <i class="{{icon}}"></i>{{text}}</button>',templateLoadUrl:"",templateItemTemplate:'<div class="bs-template-item" id="{{id}}">  <div class="bs-template-item-image">    <img src="{{imageUrl}}" class="img-fluid" />  </div>  <div class="bs-template-item-desc">    <span class="bs-template-item-title">{{title}}</span>    <button type="button" class="btn btn-link">加载此模板</button>  </div></div>'},i=[{name:"tag",type:"input",label:"组件类型",placeholder:"",disabled:!0,required:!0,index:10},{name:"id",type:"input",label:"id",placeholder:"",disabled:!1,required:!0,index:20},{name:"name",type:"input",label:"name",placeholder:"",disabled:!1,required:!0,index:30},{name:"label",type:"input",label:"标签名",placeholder:"",disabled:!1,required:!1,index:40},{name:"required",type:"switch",label:"是否必填",placeholder:"",disabled:!1,required:!1,index:40}],r={input:function(){return'<div class="form-group clearfix">       <div class="form-label-left">             {{~ if(required)}}             <span class="red required">*</span>             {{~end}}              <label for="{{id}}">{{label}}</label>        </div>        <div class="flex-auto">             <input id="{{id}}" {{~if (disabled)}}disabled{{~end}} type="text" data-attr="{{name}}" placeholder="{{placeholder}}" class="onkeyup form-control" value="{{value}}">        </div>    </div>'},textarea:function(){return'<div class="form-group clearfix">       <div class="form-label-left">             {{~ if(required)}}             <span class="red required">*</span>             {{~end}}              <label for="{{id}}">{{label}}</label>        </div>        <div class="flex-auto">             <textarea id="{{id}}" {{~if (disabled)}}disabled{{~end}} rows="3" data-attr="{{name}}" placeholder="{{placeholder}}" class="onkeyup form-control">{{value}}</textarea>        </div>    </div>'},select:function(){return'<div class="form-group clearfix">       <div class="form-label-left">            <legend class="col-form-label pt-0">{{label}}</legend>        </div>        <div class="flex-auto">            <select class="custom-select onchange" {{~if (disabled)}}disabled{{~end}} data-attr="{{name}}">                   {{~for (let option of options)}}                   <option value="{{option.value}}" {{~if(option.value == value)}}selected=""{{~end}}>{{option.text}}</option>                   {{~end}}             </select>        </div>    </div>'},number:function(){return'<div class="form-group clearfix">  <div class="form-label-left">    <label for="{{id}}">{{label}}</label>  </div>  <div class="flex-auto">    <input type="number" {{~if (disabled)}}disabled{{~end}} data-attr="{{name}}" class="form-control onchange onkeyup" value="{{value}}" />  </div></div>'},switch:function(){return'<div class="form-group clearfix">  <div class="form-label-left">    <legend class="col-form-label pt-0" for="{{id}}">{{label}}</legend>  </div>  <div class="flex-auto">    <div class="custom-control custom-switch">      <input type="checkbox" {{~if (disabled)}}disabled{{~end}} value="true" {{~if(value)}} checked {{~end}} data-attr="{{name}}"            class="custom-control-input onchange" id="{{id}}" />      <label class="custom-control-label" for="{{id}}"></label>    </div>  </div></div>'},checkbox:function(){return'<div class="form-group clearfix">  <div class="form-label-left">    <legend class="col-form-label pt-0">{{label}}</legend>  </div>  <div class="flex-auto">    {{~ for(let option of options)}}    <div class="form-check form-check-inline">      <input class="form-check-input onchange" {{~if (disabled)}}disabled{{~end}} {{~ if(value.indexOf(option.value) >=0 )}} checked {{~end}}            type="checkbox" data-attr="{{name}}" data-type="array"           id="{{option.value}}-{{id}}" value="{{option.value}}" />      <label class="form-check-label" for="{{option.value}}-{{id}}">{{option.text}}</label>    </div>    {{~end}}  </div></div>'},radio:function(){return'<div class="form-group clearfix">  <div class="form-label-left">    <legend class="col-form-label pt-0">{{label}}</legend>  </div>  <div class="flex-auto">    {{~ for(let option of options)}}    <div class="form-check form-check-inline">      <input class="form-check-input onchange" name="{{id}}" type="radio"            {{~if (disabled)}}disabled{{~end}}            {{~ if(value == option.value )}} checked {{~end}}            data-attr="{{name}}" id="{{option.value}}-{{id}}" value="{{option.value}}" />      <label class="form-check-label" for="{{option.value}}-{{id}}">{{option.text}}</label>    </div>    {{~end}}  </div></div>'},options:function(){return'<div class="option-box options">  <div class="divider-title option-filtered">{{title}}</div>  {{~for (let option of options)}}  <div class="form-group form-check-inline clearfix option-item" id="{{option.elementId}}">    <i class="bi bi-arrows-move pointer pr-2 option-handle"></i>    <input type="text" value="{{option.text}}" class="form-control mr-2 option-input text" />    <input type="text" value="{{option.value}}" class="form-control mr-2 option-input value" />    <i class="bi bi-dash-square red pointer option-delete"></i>  </div>  {{~end}}  <div class="text-center option-filtered">    <button type="button" class="btn btn-primary btn-sm option-add">添 加</button>  </div></div>'}},l=[{name:"DIV",tag:"div",drag:{title:"DIV",type:"container",index:100,icon:"bi bi-fullscreen"},props:[{name:"className",type:"input",label:"Class样式"},{name:"style",type:"textarea",label:"Style样式"}],template:'<div class="bsFormItem" id="{{id}}">   <div class="bsItemContainer {{className}}" style="{{style}}">{{$children[0]}}</div></div>'},{name:"等分栅格",tag:"grid",drag:{title:"等分栅格",type:"container",index:100,icon:"bi bi-grid"},props:[{name:"grid",type:"radio",label:"栅格数",defaultValue:2,options:[{value:2,text:2},{value:3,text:3},{value:4,text:4}]}],template:'<div class="bsFormItem">  <div class="form-group clearfix">    <div class="row pdlr-15">      {{~for (var i=0;i<grid;i++)}}      <div class="col-{{12/grid}} bsItemContainer">{{$children[i]}}</div>      {{~end}}    </div>  </div></div>',onPropChange:function(o,t,e,n){if("grid"!==e)return!1;var i=o.currentData,a=Number.parseInt(n),r=c("#"+i.elementId).children(".form-group").children(),s=r.children().length;if(a<s)for(let t=0;t<s-a;t++){var l=r.children(":last"),d=l.data("bsItemSortable"),d=(d&&d.destroy(),o._getItemContainerIndex(l));i.children&&i.children[d]&&delete i.children[d],l.find(".bsItemContainer").each(function(){var t=c(this).data("bsItemSortable");t&&t.destroy()}),l.remove()}if(s<a)for(let t=0;t<a-s;t++)r.append('<div class="bsItemContainer"></div>');return r.children().each(function(t,e){var n;c(this).data("bsItemSortable")||(n=new Sortable(c(this)[0],{group:"shared",animation:150,onAdd:function(t){o._onDragAdd(t)},onEnd:function(t){o._onDragEnd(t)}}),c(this).data("bsItemSortable",n))}),r.children().attr("class","bsItemContainer col-"+12/Number.parseInt(n)),!0}},{name:"灵活栅格",tag:"sgrid",drag:{title:"灵活栅格",type:"container",index:100,icon:"bi bi-grid-1x2"},optionsCounter:2,withOptions:!0,optionsTitle:"栅格配置",optionsTypes:"custom",opiontsAdd:function(){return{text:"栅格"+ ++this.optionsCounter,value:12}},defaultOptions:[{text:"栅格1",value:6},{text:"栅格2",value:6}],template:'<div class="bsFormItem">  <div class="form-group clearfix">    <div class="row pdlr-15">      {{~for (var i = 0;i<options.length;i++)}}      <div class="col-{{options[i].value}} bsItemContainer">{{$children[i]}}</div>      {{~end}}    </div>  </div></div>',onPropChange:function(t,e,n,o){if("options"!==n||!e.children)return!1;var i={},a=e.options,r=o;for(let t=0;t<a.length;t++)i[a[t].elementId]=e.children[t];for(let t=0;t<r.length;t++){var s=r[t];e.children[t]=i[s.elementId]}}},{name:"Tab选项卡",tag:"tab",drag:{title:"Tab选项卡",type:"container",index:100,icon:"bi bi-menu-button"},withOptions:!0,optionsTypes:"custom",counter:1,defaultOptions:function(t,e){var n=this.counter++,o=this.counter++;return[{text:"标签"+n,value:"tab_id_"+n},{text:"标签"+o,value:"tab_id_"+o}]},template:'<div class="bsFormItem">  <div class="form-group clearfix">    <div class="pdlr-15">      <ul class="nav nav-tabs" role="tablist">        {{~for (var i = 0;i<options.length;i++)}}        <li class="nav-item">          <a class="nav-link {{~if (i == 0)}}active {{~end}}" id="{{options[i].value}}-tab" data-toggle="tab" href="#{{options[i].value}}"            role="tab" aria-controls="{{options[i].value}}" aria-selected="{{~if(i==0)}}true{{~else}}false{{~end}}" >{{options[i].text}}</a >        </li>        {{~end}}      </ul>      <div class="tab-content">        {{~for (var i = 0;i<options.length;i++)}}        <div class="bsItemContainer tab-pane fade {{~if (i == 0)}}active show {{~end}}"          id="{{options[i].value}}" role="tabpanel" aria-labelledby="{{options[i].value}}-tab" >          {{$children[i]}}        </div>        {{~end}}      </div>    </div>  </div></div>',onAdd:function(t,e){c("#"+e.elementId).find(".nav-link").on("click",function(t){return t.stopPropagation(),c(this).tab("show"),!1})},onPropChange:function(t,e,n,o){if("options"!==n||!e.children)return!1;var i={},a=e.options,r=o;for(let t=0;t<a.length;t++)i[a[t].elementId]=e.children[t];for(let t=0;t<r.length;t++){var s=r[t];e.children[t]=i[s.elementId]}}}];a.prototype={_initViewMode:function(){if(this._initViewStructure(),this.$container=this.$rootEl.find(this.options.bsFormContainerSelector),0===this.$container.length)throw new Error("Can not file container by: "+this.options.bsFormContainerFilterSelector);var t=this;this._initComponents(function(){t._initData(this.options.datas,!0),t._refreshViewContainer(),t._invokeOnInitCallback()})},_initBuilderMode:function(){if(!0!==this.options.customBuilderStructure&&this._initBuilderStructure(),this.$container=this.$rootEl.find(this.options.bsFormContainerSelector),0===this.$container.length)throw new Error("Can not file container by: "+this.options.bsFormContainerSelector);this.$containerPlaceHolder=this.$rootEl.find(this.options.bsFormContainerPlaceHolderSelector),this.$propsPanelTitle=this.$rootEl.find(this.options.bsFormPropsTitleSelector),this.$propsPanel=this.$rootEl.find(this.options.bsFormPropsSelector);var n=this;this._initComponents(function(){n._initActionButtons(),n._initDragComponents();function t(t){n._initData(t,!0),n._refreshBuilderContainer(),n._initEvents(),n._initSortables(),n._invokeOnInitCallback()}var e=n.options.datas;"string"==typeof e&&n._isUrl(e)?n._ajaxGet(e,"datas",t):"object"==typeof e&&Array.isArray(e)?t(e):"function"==typeof e?"object"==typeof(e=e(t))&&Array.isArray(e)&&t(e):t()})},_invokeOnInitCallback:function(){"function"==typeof this.options.onInit&&this.options.onInit(this)},_initData:function(t,e){if(t&&0!==t.length){t.sort((t,e)=>t.index-e.index);for(var n of t)if(n&&n.tag){var o=this.components[n.tag];if(o){if(o.props)for(const a of o.props)void 0===a.defaultValue||n[a.name]||(n[a.name]=a.defaultValue);if(n.component=o,n.elementId=this.genRandomId(),n.children)for(var i of Object.values(n.children))this._initData(i,!1);e&&this.datas.push(n)}else console.warn("Can not find component by tag: "+n.tag)}}},_refreshViewContainer:function(){this.$container.children(".bsFormItem").remove();for(var t of this.datas){t=this.render(t,!1).outerHTML;this.$container.append(t)}},_initViewStructure:function(){this.$rootEl.append('<div class="row bsFormViewRoot"><div class="col-12 bsFormContainer"></div></div>')},_initBuilderStructure:function(){this.$rootEl.append('<div class="row bsFormBuilderRoot">  \x3c!--左侧拖拽区域--\x3e  <div class="col-md-3 col-sm-4">    <div class="bsFormPanel pd10 border-right">      <ul class="nav nav-tabs mb-2" id="formTab" role="tablist">        <li class="nav-item w-50">          <a class="nav-link active" id="component-tab" data-toggle="tab" href="#component"            role="tab" aria-controls="component" aria-selected="true">表单组件</a>        </li>        <li class="nav-item w-50">          <a class="nav-link" id="module-tab"  data-toggle="tab" href="#template"            role="tab" aria-controls="module" aria-selected="false">表单模板</a>        </li>      </ul>      <div class="tab-content">        <div class="tab-pane fade show active" id="component" role="tabpanel" aria-labelledby="component-tab" >          <div class="bsFormDrags-title">表单组件</div>          <div class="bsFormDrags d-flex align-items-center" data-type="base"></div>          <div class="bsFormDrags-title">辅助组件</div>          <div class="bsFormDrags d-flex align-items-center" data-type="assist"></div>          <div class="bsFormDrags-title">布局组件</div>          <div class="bsFormDrags d-flex align-items-center" data-type="container"></div>        </div>        <div class="tab-pane fade" id="template"  role="tabpanel" aria-labelledby="module-tab">          <div id="bs-template-item-list" class="bs-template-item-list"></div>        </div>      </div>    </div>  </div>  \x3c!-- 中间内容 --\x3e  <div class="bsFormPanel col-md-6 col-sm-4">    <div class="w-100 pd10 border-bottom text-right pt-1 pb-1 bsFormActions"></div>    <div style="width: 100%;" class="bsFormContainer">      <div class="bsFormContainer-placeholder">从左侧拖入组件进行表单设计</div>    </div>  </div>  \x3c!-- 属性内容 --\x3e  <div class="col-md-3 col-sm-4">    <div class="bsFormPanel pd10 border-left">      <ul class="nav nav-tabs mb-2" id="formAttrTab" role="tablist">        <li class="nav-item w-50">          <a  class="nav-link active" id="component-props-tab" data-toggle="tab" href="#bsFormProps"            role="tab" aria-controls="component" aria-selected="true">组件属性</a>        </li>      </ul>      <div class="tab-content pt-3">        <div class="tab-pane fade show active bsFormProps" id="bsFormProps" role="tabpanel" aria-labelledby="component-props-tab">        </div>      </div>    </div>  </div></div>')},_initActionButtons:function(){var a=this.options.actionButtonTemplate;if(a&&""!==a){let i=this;for(let o of this.options.actionButtons||[]){let t=["$button","text","mainClass","icon"],e=t.map(t=>o[t]||"");e[0]=o;var r=this._renderTemplate(a,t,e);let n=c(r).attr("id",this.genRandomId());n.appendTo(".bsFormActions"),"function"==typeof o.onclick&&n.on("click",function(t){o.onclick(t,i)})}}},_initComponents:function(n){var t,e=(e=this.options.useComponents)||[],o=(o=this.options.unUseComponents)||[];for(t of l)t&&(0===e.length||-1<e.indexOf(t.tag))&&-1===o.indexOf(t.tag)&&(this.components[t.tag]=t);if(window.bsComponentsDef)for(var i of window.bsComponentsDef)i&&(0===e.length||-1<e.indexOf(i.tag))&&-1===o.indexOf(i.tag)&&(this.components[i.tag]=i);function a(t){for(var e of t)e&&e.tag&&(e=c.extend(r.components[e.tag],e),r.components[e.tag]=e);n()}var r=this,s=this.options.components;"string"==typeof s&&this._isUrl(s)?this._ajaxGet(s,"components",a):"object"==typeof s&&Array.isArray(s)?a(s):"function"==typeof s?"object"==typeof(s=s(a))&&Array.isArray(s)&&a(s):n()},_isUrl:function(t){return t&&(0===t.indexOf("/")||0===t.indexOf("http://")||0===t.indexOf("https://"))},_ajaxGet:function(e,n,o){var t=this.ajaxCache[e],i=(!t||(t=t[n])&&o(t),this);c.ajax({url:e,type:"GET",success:function(t){t=(i.ajaxCache[e]=t)[n];t&&o(t)}})},_ajaxSyncGet:function(t){var e=this.ajaxCache[t];if(e)return e;var n="";return c.ajax({url:t,async:!1,type:"GET",success:function(t){n=t}}),this.ajaxCache[t]=n},_ajaxSyncPost:function(t,e){var n="";return c.ajax({url:t,async:!1,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(e),success:function(t){n=t}}),n},_initDragComponents:function(){if(this.components&&0!==this.components.length){var t,e,n,a={};for(t of Object.values(this.components))t.drag&&(t.drag.type?(t.drag.tag=t.tag,(e=a[t.drag.type])||(e=[],a[t.drag.type]=e),e.push(t.drag)):console.error("Component define error! it must defined drag.type in component. ",t));for(n of Object.values(a))n.sort((t,e)=>t.index-e.index);var r=this;c(".bsFormDrags").each(function(t,e){var n=c(e),e=n.data("type"),o=a[e];if(o&&0<o.length){n.find(".placeholder").remove();for(var i of o)i.icon&&"<"===i.icon.trim().charAt(0)?n.append('<ol data-tag="'+i.tag+'"><div class="item-icon">'+i.icon+'"</div><div class="item-title">'+i.title+"</div></ol>"):n.append('<ol data-tag="'+i.tag+'"><div class="item-icon"><i class="'+i.icon+'"></i></div><div class="item-title">'+i.title+"</div></ol>")}else r.options.renderEmptyDrags&&"function"==typeof r.options.renderEmptyDrags&&r.options.renderEmptyDrags(r,n,e)})}},_refreshBuilderContainer:function(){if(this.$container.find(".bsItemContainer").each(function(){let t=c(this).data("bsItemSortable");t&&t.destroy()}),this.$container.children(".bsFormItem").remove(),this.datas&&0!==this.datas.length){this.$containerPlaceHolder.hide();for(var t of this.datas){var e=this.render(t,!1);this._invokeComponentOnAddBefore(t,e),this.$container.append(e.outerHTML),this._invokeComponentOnAdd(t)}}else this.$containerPlaceHolder.show()},_initEvents:function(){function t(t){var e,n,o=c(this).attr("data-attr"),i=c(this).val();"array"===c(this).attr("data-type")?(n=(e=a.currentData[o]||[]).indexOf(i),"checkbox"===t.currentTarget.type&&(t.currentTarget.checked&&-1===n?e.push(i):!t.currentTarget.checked&&0<=n&&e.splice(n,1)),i=e):"checkbox"===t.currentTarget.type&&(i=t.currentTarget.checked),a.currentData?a.updateDataAttr(a.currentData,o,i):console.error("error: Current data not exits!!!")}var a=this;this.$container.on("click",".bsFormItem",function(t){t.stopPropagation(),a.makeFormItemActive(c(this).attr("id"))}),this.$container.on("click",".bs-item-copy",function(t){t.stopPropagation();t=c(this).closest(".bsFormItem").attr("id");a.copyFormItem(t)}),this.$container.on("click",".bs-item-del",function(t){t.stopPropagation();t=c(this).closest(".bsFormItem");a.deleteFormItem(t.attr("id")),a.datas&&0!==a.datas.length||a.$containerPlaceHolder.show()});this.$propsPanel.on("keyup",".onkeyup",t),this.$propsPanel.on("change",".onchange",t),this.$propsPanel.on("keyup",".option-input",function(){a._syncCurrentDataOptionsFromPropSetting()}),this.$propsPanel.on("click",".option-delete",function(t){c(this).closest(".option-item").remove(),a._syncCurrentDataOptionsFromPropSetting()}),this.$propsPanel.on("click",".option-add",function(t){var e=a.deepCopy(a.currentData.options,!1)||[],n=a.optionsCounter++,o=null;(o=(o=a.currentData.component.opiontsAdd?"function"==typeof a.currentData.component.opiontsAdd?a.currentData.component.opiontsAdd(a):a.currentData.component.opiontsAdd:o)||{text:"选项"+n,value:"value"+n}).elementId||(o.elementId=a.genRandomId()),e.push(o),a.updateDataAttr(a.currentData,"options",e),a.refreshPropsPanel()})},_initSortables:function(){var t,o=this;c(".bsFormDrags").each(function(t,e){var n,e=c(e);e.data("sortable")||(n=e.data("group")||"shared",n=new Sortable(e[0],{group:{name:n,pull:"clone",put:!1},filter:".filtered,.placeholder",animation:150,sort:!1,onStart:function(t){o.$containerPlaceHolder&&o.$containerPlaceHolder.hide()},onEnd:function(t){0===o.datas.length&&o.$containerPlaceHolder.show()}}),e.data("sortable",n))}),this.$container.data("sortable")||(t=new Sortable(this.$container[0],{group:this.options.bsFormContainerSortableGroup,filter:this.options.bsFormContainerFilterSelector,animation:150,onAdd:function(t){o._onDragAdd(t)},onEnd:function(t){o._onDragEnd(t)}}),this.$container.data("sortable",t))},_onDragAdd:function(t){var e=null,n=c(t.item),o=n.attr("data-tag"),o=(o?(e=this.createComponentData(this.components[o]),o=this.render(e,!1),this._invokeComponentOnAddBefore(e,o),c(t.item).replaceWith(o),this._invokeComponentOnAdd(e)):e=this.getDataByElementId(n.attr("id")),this.removeDataByElementId(e.elementId),c(t.to));o.is(this.options.bsFormContainerSelector)?(delete e.parentDataId,delete e.parentDataIndex,this.datas.push(e)):(n=o.closest(".bsFormItem").attr("id"),t=this._getItemContainerIndex(o),void 0===(n=this.getDataByElementId(n)).children&&(n.children={}),void 0===n.children[t]&&(n.children[""+t]=[]),e.parentDataId=n.id,e.parentDataIndex=t,n.children[t].push(e)),this.makeFormItemActive(e.elementId),this.refreshDataIndex(o)},_getItemContainerIndex:function(n){var o=0;return n.parent().children(".bsItemContainer").each(function(t,e){e===n[0]&&(o=t)}),o},_invokeComponentOnAddBefore:function(t,e){t.component&&"function"==typeof t.component.onAddBefore&&t.component.onAddBefore(this,t,e)},_invokeComponentOnAdd:function(t){let e=this;c("#"+t.elementId).find(".bsItemContainer").each(function(){var t;c(this).data("bsItemSortable")||(t=new Sortable(c(this)[0],{group:"shared",animation:150,onAdd:function(t){e._onDragAdd(t)},onEnd:function(t){e._onDragEnd(t)}}),c(this).data("bsItemSortable",t))}),t.component&&"function"==typeof t.component.onAdd&&t.component.onAdd(this,t)},_invokeComponentOnDelete:function(t){c("#"+t.elementId).find(".bsItemContainer").each(function(){var t=c(this).data("bsItemSortable");t&&t.destroy()}),t.component&&"function"==typeof t.component.onDelete&&t.component.onDelete(this,t)},_onDragEnd:function(t){this.refreshDataIndex(c(t.from))},_renderTemplate:function(t,e,n){var o={};for(let t=0;t<e.length;t++)o[e[t]]=n[t];return this.options.templateEngine.render(t,o)},_initDataOptionsIfNecessary:function(t){var e,n;t.component.withOptions&&!t.options&&((e="function"==typeof(e=t.component.defaultOptions)?t.component.defaultOptions(this,this.currentData):e)||(n=this._getOptionDatasources())&&0<n.length&&(e=this._parseOptions(n[0].options),t.optionsDatasource=n[0].value),t.options=e||[],t.options.forEach(t=>{t.elementId=this.genRandomId()}),t.optionsTitle=t.component.optionsTitle||"选项")},_getPropTemplateByType:function(t){let e=this.propTemplates[t];if((e="function"==typeof e?e():e)||"none"===t)return e;throw new Error("Not define prop template for type: "+t)},_syncCurrentDataOptionsFromPropSetting:function(){var i=[];this.$propsPanel.children(".options").children(".option-item").each(function(t,e){var n=c(e).children(".option-input.text").val(),o=c(e).children(".option-input.value").val(),e=c(e).attr("id");i.push({text:n,value:o,elementId:e})}),this.updateDataAttr(this.currentData,"options",i)},createComponentData:function(t){var e,n=t.onDataCreate&&"function"==typeof t.onDataCreate?t.onDataCreate():{};n.elementId=this.genRandomId(),n.id=this.genRandomId(),n.tag=t.tag,n.component=t,n.label||(n.label=t.name),n.name||(n.name=t.tag+"_"+this.componentCounter++);for(e of this._getComponentAllProps(t,n))void 0===e.defaultValue||n[e.name]||(n[e.name]=e.defaultValue);return n},genRandomId:function(){for(var t=[],e=0;e<10;e++)t[e]="0123456789abcdef".substr(Math.floor(16*Math.random()),1);return this.options.componentIdPrefix+t.join("")},renderDefault:function(e){let n=[];if("object"==typeof e.children)for(var o of Object.keys(e.children)){var i=e.children?e.children[o]:[];let t="";if(i)for(var a of i){a=this.render(a,!1);a&&(t+=a.outerHTML)}n[o]=t}var t=new Proxy(n,{get:function(t,e){return t[e]||""}}),r=this.defaultProps.map(t=>t.name).concat(["value","placeholder","options"]),r=(e.component.props&&(r=r.concat(e.component.props.map(t=>t.name))),["$builder","$component","$data","$children"].concat(r)),s=r.map(t=>e[t]||"");return s[0]=this,s[1]=e.component,s[2]=e,s[3]=t,this._renderTemplate(e.component.template,r,s)},deepCopy:function(t,e){var n,o=Array.isArray(t)?[]:{};if(t&&"object"==typeof t)for(var i in t)t.hasOwnProperty(i)&&(t[i]&&"object"==typeof t[i]?o[i]=this.deepCopy(t[i],e):(n=t[i],!e||"elementId"!==i&&"id"!==i||(n=this.genRandomId()),o[i]=n));return o},render:function(t,e){var n=t.component,o=null,n=(this._initDataOptionsIfNecessary(t),"function"==typeof n.template?o=n.template(this,t):this.options.customRender&&("function"==typeof this.options.customRender?o=this.options.customRender(this,t):"string"==typeof this.options.customRender&&this._isUrl(this.options.customRender)&&(o=this._ajaxSyncPost(this.options.customRender,t))),o=o||this.renderDefault(t),c(o).attr("id",t.elementId).addClass("bsFormItem"));return e&&this._makeElementActive(n,this.currentData.component.disableTools),n[0]},makeFormItemActive:function(t){this.currentData&&this.currentData.elementId===t||(this.currentData=this.getDataByElementId(t),this.$container.find(".bsFormItem.active").removeClass("active"),this.$container.find(".bs-item-tools").remove(),this._makeElementActive(c("#"+t),this.currentData.component.disableTools),this.refreshPropsPanel())},_makeElementActive:function(t,e){(!0!==e?t.append('<div class="bs-item-tools">               <i class="bi bi-stickies-fill bs-item-copy" title="复制"></i>               <i class="bi bi-trash-fill bs-item-del" title="删除"></i>           </div>'):t).addClass("active")},deleteFormItem:function(t){this.currentData&&this.currentData.elementId===t&&(this.currentData=null,this.refreshPropsPanel());var e=this.getDataByElementId(t);e&&(this._invokeComponentOnDelete(e),delete e,this.removeDataByElementId(t),c("#"+t).remove())},copyFormItem:function(t){var e,n,o=this.getDataByElementId(t);o&&(o=this.deepCopy(o,!0),e=this.render(o,!1),n=c("#"+t),this._invokeComponentOnAddBefore(o,e),n.after(e),this._invokeComponentOnAdd(o),this.getParentArrayByElementId(t).push(o),this.refreshDataIndex(n.parent()))},getDataByElementId:function(t){return this.getDataByElementIdInArray(this.datas,t)},getDataByElementIdInArray:function(t,e){if(!t||0===t.length)return null;for(var n of t){if(n&&n.elementId===e)return n;if(n.children&&"object"==typeof n.children)for(var o of Object.values(n.children)){o=this.getDataByElementIdInArray(o,e);if(o)return o}}return null},removeDataByElementId:function(t){return this.removeDataByElementIdInArray(this.datas,t)},removeDataByElementIdInArray:function(e,n){if(e&&0!==e.length)for(let t=0;t<e.length;t++){var o=e[t];if(o&&o.elementId===n){e.splice(t,1);break}if(o.children&&"object"==typeof o.children)for(var i of Object.values(o.children))this.removeDataByElementIdInArray(i,n)}},getParentArrayByElementId:function(t){return this.getParentArrayByElementIdInArray(this.datas,t)},getParentArrayByElementIdInArray:function(e,n){if(!e||0===e.length)return null;for(let t=0;t<e.length;t++){var o=e[t];if(o&&o.elementId===n)return e;if(o.children&&"object"==typeof o.children)for(var i of Object.values(o.children)){i=this.getParentArrayByElementIdInArray(i,n);if(i)return i}}return null},refreshDataIndex:function(t){var n=this;t.children(".bsFormItem").each(function(t,e){e=c(e).attr("id");n.getDataByElementId(e).index=t})},refreshPropsPanel:function(){var e,n,o,i=this.$propsPanel.children(".options").data("sortable");if(i&&i.destroy(),this.$propsPanel.html(""),this.currentData){let t=this.currentData.component;if(0<this.$propsPanelTitle.length&&(this.$propsPanelTitle.find(".text").text(t.name),t.drag.icon?(i="",i=t.drag.icon&&"<"===t.drag.icon.trim().charAt(0)?t.drag.icon:'<i class="'+t.drag.icon+'">',this.$propsPanelTitle.find(".icon").html(i)):this.$propsPanelTitle.find(".icon").html("")),"function"==typeof t.onRenderPropsPanel)return i=t.onRenderPropsPanel(this),void this.$propsPanel.append(i);for(e of this._getComponentAllProps(t,this.currentData)){var a,r,s=this._getPropTemplateByType(e.type);s&&((a=this.deepCopy(e,!1)).id=this.genRandomId(),void 0===(r=this.currentData[e.name])&&(r=e.defaultValue),a.value=r,this._appendPropsPanel(a,this.currentData,s))}(this.currentData.component.withOptions||this.currentData.options)&&(this._initDataOptionsIfNecessary(this.currentData),"string"==typeof(i=this.currentData.component.optionsTypes)?i=[i]:"function"==typeof i&&(i=this.currentData.component.optionsTypes(this,this.currentData)),i=i||["custom","datasource"],(o=this._getOptionDatasources())&&0<o.length&&1<i.length&&(i={id:this.genRandomId(),options:[{text:"自定义",value:"custom"},{text:"数据源",value:"datasource"}],label:"选项类型",name:"optionsType",value:this.currentData.optionsType},n=this._getPropTemplateByType("select"),this._appendPropsPanel(i,this.currentData,n)),"datasource"===this.currentData.optionsType?(i={id:this.genRandomId(),options:o||[{text:"未定义任何数据源",value:""}],label:"数据源",name:"optionsDatasource",value:this.currentData.optionsDatasource},n=this._getPropTemplateByType("select"),this._appendPropsPanel(i,this.currentData,n)):(o={id:this.genRandomId(),options:this.currentData.options||[],title:this.currentData.optionsTitle||"选项"},i=this._getPropTemplateByType("options"),this._appendPropsPanel(o,this.currentData,i),this._initOptionsSortable()))}},_appendPropsPanel:function(t,e,n){let o=this.renderPropTemplate(t,e,n);this.options.bsFormPropsItemAppendBefore&&"function"==typeof this.options.bsFormPropsItemAppendBefore&&(o=this.options.bsFormPropsItemAppendBefore(this,t,e,o)),this.$propsPanel.append(o),this.options.bsFormPropsItemAppended&&"function"==typeof this.options.bsFormPropsItemAppended&&this.options.bsFormPropsItemAppended(this,t,e)},_getComponentAllProps:function(t,e){var n=this.deepCopy(this.defaultProps,!1);let o="function"==typeof t.useProps?t.useProps(this,e):"object"==typeof t.useProps?t.useProps:[];if(o&&0<o.length)for(var i=n.length;i--;)o.indexOf(n[i].name)<0&&n.splice(i,1);t="object"==typeof t.props?t.props:[],t=this._mergeProps(t,n);return t.sort((t,e)=>t.index-e.index),this.options.bsFormPropsFilter&&"function"==typeof this.options.bsFormPropsFilter&&this.options.bsFormPropsFilter(t,e,this),t},_getOptionDatasources:function(){var t,e=this.options.optionsDatasources;return"function"==typeof e?e=e(this,this.currentData):"string"==typeof e&&this._isUrl(e)&&(t=this._ajaxSyncGet(e))&&t.datasources&&(e=t.datasources),e},_parseOptions:function(t){if("object"==typeof t&&Array.isArray(t))return t;if("function"==typeof t)return t(this,this.currentData);if("string"==typeof t&&this._isUrl(t)){t=this._ajaxSyncGet(t);if(t&&t.options)return t.options}},_mergeProps:function(t,e){var n,o=[].concat(e);for(n of t){var i=!1;for(let t=0;t<e.length;t++)o[t].name===n.name&&(o[t]=n,i=!0);i||o.push(n)}return o},_initOptionsSortable:function(){var t,e=this.$propsPanel.children(".options");0<e.length&&(t=new Sortable(e[0],{handle:".option-handle",filter:".filtered",animation:150,onEnd:()=>this._syncCurrentDataOptionsFromPropSetting()}),e.data("sortable",t))},renderPropTemplate:function(e,t,n){var o=c.extend({disabled:!1,required:!1,id:"",label:"",name:"",placeholder:"",type:"",value:""},e),o=["$builder","$prop","$data"].concat(Object.keys(o)),i=o.map(t=>e[t]||"");return i[0]=this,i[1]=e,i[2]=t,this._renderTemplate(n,o,i)},exportToJson:function(){var t=this.deepCopy(this.datas,!1);return this._arrangeExportData(t),JSON.stringify(t)},exportToHtml:function(){var t,e=this.deepCopy(this.datas,!1),n=(e.sort((t,e)=>t.index-e.index),"");for(t of e)n+=this.render(t,!1).outerHTML;return n},_arrangeExportData:function(t){if(t&&0!==t.length){t.sort((t,e)=>t.index-e.index);for(var e of t)if(delete e.component,delete e.elementId,delete e.customOptions,e.options&&Array.isArray(e.options)&&this._arrangeExportData(e.options),e.children)for(var n of Object.values(e.children))this._arrangeExportData(n)}},getDatas:function(){return this.datas},addDataToRoot:function(t){this.addDatasToRoot([t])},addDatasToRoot:function(t){this._initData(t,!0),this.isBuilderMode()?this._refreshBuilderContainer():this.isViewMode()&&this._refreshViewContainer()},addDataToContainer:function(t,e,n){this.addDatasToContainer([t],e,n)},addDatasToContainer:function(t,e,n){this._initData(t,!1);var o=this.getDataByElementId(e);o?(o.children||(o.children={}),o.children[n]||(o.children[n]=[]),o.children[n].push(...t),this.refreshDataElement(o)):console.error("Can not find data by elementId: "+e)},refreshDataElement:function(t){var e=this.render(t,!0),n=c("#"+t.elementId);n.find(".bsItemContainer").each(function(){let t=c(this).data("bsItemSortable");t&&t.destroy()}),this._invokeComponentOnAddBefore(t,e),n.replaceWith(e),this._invokeComponentOnAdd(t)},updateDataAttr:function(t,e,n){if(t){"true"===n?n=!0:"false"===n&&(n=!1);var o=t[e];if("optionsDatasource"===e){var i=this._getOptionDatasources(),a=null;if(i&&0<i.length)for(var r of i)r.value.toString()===n&&(a=this._parseOptions(r.options));this.updateDataAttr(t,"options",a)}t.component&&"function"==typeof t.component.onPropChange&&t.component.onPropChange(this,t,e,n)||this.options.onDataChange&&"function"==typeof this.options.onDataChange&&this.options.onDataChange(this,t,e,n)?t[e]=n:(t[e]=n,this.refreshDataElement(t)),"optionsType"===e&&t===this.currentData&&("datasource"===n?(this._cacheCustomOptions(t),i=t.optionsDatasource||this._getOptionDatasources()[0].value,this.updateDataAttr(t,"optionsDatasource",i)):this._resumeCustomOptions(t),this.refreshPropsPanel()),"function"==typeof this.options.onDataChanged&&this.options.onDataChanged(t,e,n,o)}else console.error("data must not be null.")},_cacheCustomOptions:function(t){this.updateDataAttr(t,"customOptions",t.options)},_resumeCustomOptions:function(t){this.updateDataAttr(t,"options",t.customOptions),this.updateDataAttr(t,"customOptions",null)},isViewMode:function(){return"view"===this.options.mode},isBuilderMode:function(){return"builder"===this.options.mode},clear:function(){this.datas=[],this._refreshBuilderContainer(),this.currentData=null,this.refreshPropsPanel()},destroy:function(){this.options=null,this.defaultProps=null,this.propTemplates=null,this.useComponents=null,this.$container=null,this.$containerPlaceHolder=null,this.$propsPanel=null,this.components=null,this.datas=null,this.currentData=null,this.$rootEl.data("bsFormBuilder",null),this.$rootEl.html(""),this.$rootEl=null}},c.fn.bsFormBuilder=function(n){var o=arguments,i="object"==typeof n&&n;return this.each(function(){var t=c(this),e=t.data("bsFormBuilder");e||t.data("bsFormBuilder",e=new a(this,i)),"string"==typeof n&&((t=e[n])?1<o.length?t.apply(e,Array.prototype.slice.call(o,1)):t():console.error("bsFormBuilder has not the method: "+n))})}}(jQuery);