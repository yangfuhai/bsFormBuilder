/*
 * bsFormBuilder 1.0.0
 * A Form Builder base on JQuery and Bootstrap.
 * https://gitee.com/fuhai/bsFormBuilder
 *
 * Copyright 2022, Michael <fuhai999@gmail.com>
 * Released under the LGPL license.
*/

!function(c){function a(e,t){this.options=c.extend(o,t),this.defaultProps=t.defaultOptions||[];for(var n of i)-1===this.defaultProps.map(e=>e.name).indexOf(n.name)&&this.defaultProps.push(n);this.propTemplates=c.extend(r,t.propTemplates),this.useComponents=t.useComponents||[],this.$rootEl=c(e),this.$container=null,this.$containerPlaceHolder=null,this.$propsPanel=null,this.components={},this.datas=[],this.currentData=null,this.componentCounter=1,this.optionsCounter=3,"view"===this.options.mode?this._initViewMode():this._initBuilderMode()}var o={mode:"builder",useComponents:[],actionButtons:[{text:"导出 JSON",mainClass:"btn-primary",iconClass:"bi bi-arrow-up pr-1",onclick:function(e,t){var t=t.exportToJson(),n=document.createElement("a");n.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),n.setAttribute("download","bsFormBuilder.json"),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}},{text:"导出 HTML",mainClass:"btn-primary",iconClass:"bi bi-arrow-up pr-1",onclick:function(e,t){var t=t.exportToHtml(),n=document.createElement("a");n.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),n.setAttribute("download","bsFormBuilder.html"),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}},{text:"获取源码",mainClass:"btn-primary",iconClass:"bi bi-eye pr-1",onclick:function(){alert("这里的所有按钮，按钮功能都是可以自定义的~~~"),window.open("https://gitee.com/fuhai/bsFormBuilder")}},{text:"清空",mainClass:"btn-danger",iconClass:"bi bi-trash pr-1",onclick:function(e,t){t.clear()}}],actionButtonTemplate:'<button type="button" class="btn btn-sm {{mainClass}}" >  <i class="{{iconClass}}"></i>{{text}}</button>',templateLoadUrl:"",templateItemTemplate:'<div class="bs-template-item" id="{{id}}">  <div class="bs-template-item-image">    <img src="{{imageUrl}}" class="img-fluid" />  </div>  <div class="bs-template-item-desc">    <span class="bs-template-item-title">{{title}}</span>    <button type="button" class="btn btn-link">加载此模板</button>  </div></div>'},i=[{name:"tag",type:"input",label:"组件类型",placeholder:"",disabled:!0,required:!0},{name:"id",type:"input",label:"id",placeholder:"",disabled:!1,required:!0},{name:"name",type:"input",label:"name",placeholder:"",disabled:!1,required:!0},{name:"label",type:"input",label:"标签名",placeholder:"",disabled:!1,required:!1}],r={input:function(){return'<div class="form-group clearfix">       <div class="form-label-left">             {{~ if(required)}}             <span class="red required">*</span>             {{~end}}              <label for="{{id}}">{{label}}</label>        </div>        <div class="flex-auto">             <input id="{{id}}" {{~if (disabled)}}disabled{{~end}} type="text" data-attr="{{name}}" placeholder="{{placeholder}}" class="onkeyup form-control" value="{{value}}">        </div>    </div>'},textarea:function(){return'<div class="form-group clearfix">       <div class="form-label-left">             {{~ if(required)}}             <span class="red required">*</span>             {{~end}}              <label for="{{id}}">{{label}}</label>        </div>        <div class="flex-auto">             <textarea id="{{id}}" {{~if (disabled)}}disabled{{~end}} rows="3" data-attr="{{name}}" placeholder="{{placeholder}}" class="onkeyup form-control">{{value}}</textarea>        </div>    </div>'},select:function(){return'<div class="form-group clearfix">       <div class="form-label-left">            <legend class="col-form-label pt-0">{{label}}</legend>        </div>        <div class="flex-auto">            <select class="custom-select onchange" {{~if (disabled)}}disabled{{~end}} data-attr="{{name}}">                   {{~for (let option of options)}}                   <option value="{{option.value}}" {{~if(option.value == value)}}selected=""{{~end}}>{{option.text}}</option>                   {{~end}}             </select>        </div>    </div>'},number:function(){return'<div class="form-group clearfix">  <div class="form-label-left">    <label for="{{id}}">{{label}}</label>  </div>  <div class="flex-auto">    <input type="number" {{~if (disabled)}}disabled{{~end}} data-attr="{{name}}" class="form-control onchange onkeyup" value="{{value}}" />  </div></div>'},switch:function(){return'<div class="form-group clearfix">  <div class="form-label-left">    <legend class="col-form-label pt-0" for="{{id}}">{{label}}</legend>  </div>  <div class="flex-auto">    <div class="custom-control custom-switch">      <input type="checkbox" {{~if (disabled)}}disabled{{~end}} value="true" {{~if(value)}} checked {{~end}} data-attr="{{name}}"            class="custom-control-input onchange" id="{{id}}" />      <label class="custom-control-label" for="{{id}}"></label>    </div>  </div></div>'},checkbox:function(){return'<div class="form-group clearfix">  <div class="form-label-left">    <legend class="col-form-label pt-0">{{label}}</legend>  </div>  <div class="flex-auto">    {{~ for(let option of options)}}    <div class="form-check form-check-inline">      <input class="form-check-input onchange" {{~if (disabled)}}disabled{{~end}} {{~ if(value.indexOf(option.value) >=0 )}} checked {{~end}}            type="checkbox" data-attr="{{name}}" data-type="array"           id="{{option.value}}-{{id}}" value="{{option.value}}" />      <label class="form-check-label" for="{{option.value}}-{{id}}">{{option.text}}</label>    </div>    {{~end}}  </div></div>'},radio:function(){return'<div class="form-group clearfix">  <div class="form-label-left">    <legend class="col-form-label pt-0">{{label}}</legend>  </div>  <div class="flex-auto">    {{~ for(let option of options)}}    <div class="form-check form-check-inline">      <input class="form-check-input onchange" name="{{id}}" type="radio"            {{~if (disabled)}}disabled{{~end}}            {{~ if(value == option.value )}} checked {{~end}}            data-attr="{{name}}" id="{{option.value}}-{{id}}" value="{{option.value}}" />      <label class="form-check-label" for="{{option.value}}-{{id}}">{{option.text}}</label>    </div>    {{~end}}  </div></div>'},options:function(){return'<div class="option-box options">  <div class="divider-title option-filtered">{{title}}</div>  {{~for (let option of options)}}  <div class="form-group form-check-inline clearfix option-item" id="{{option.elementId}}">    <i class="bi bi-arrows-move pointer pr-2 option-handle"></i>    <input type="text" value="{{option.text}}" class="form-control mr-2 option-input text" />    <input type="text" value="{{option.value}}" class="form-control mr-2 option-input value" />    <i class="bi bi-dash-square red pointer option-delete"></i>  </div>  {{~end}}  <div class="text-center option-filtered">    <button type="button" class="btn btn-primary btn-sm option-add">添 加</button>  </div></div>'}},s=[{name:"输入框",tag:"input",drag:{title:"输入框",type:"base",index:100,iconClass:"bi bi-terminal"},template:'<div class="bs-form-item">  <div class="form-group clearfix">    <div class="form-label-left">      <label for="label">{{label}}</label>    </div>    <div class="flex-auto">      <input type="text" class="form-control" id="{{id}}"        placeholder="{{placeholder}}" value="{{value}}" />    </div>  </div></div>'},{name:"多行输入框",tag:"textarea",drag:{title:"多行输入框",type:"base",index:100,iconClass:"bi bi-textarea-resize"},props:[{name:"rows",type:"number",label:"行数",placeholder:"请输入行数...",defaultValue:3,disabled:!1,required:!0}],template:'<div class="bs-form-item">  <div class="form-group clearfix">    <div class="form-label-left">      <label for="{{id}}">{{label}}</label>    </div>    <div class="flex-auto">      <textarea name="{{name}}" class="form-control" id="{{id}}" rows="{{rows}}"        placeholder="{{placeholder}}" >{{value}}</textarea>    </div>  </div></div>'},{name:"等分栅格",tag:"grid",drag:{title:"等分栅格",type:"container",index:100,iconClass:"bi bi-grid"},props:[{name:"grid",type:"radio",label:"栅格数",defaultValue:2,options:[{value:2,text:2},{value:3,text:3},{value:4,text:4}]}],template:'<div class="bs-form-item">  <div class="form-group clearfix">    <div class="row pdlr-15">      {{~for (var i=0;i<grid;i++)}}      <div class="col-{{12/grid}} bs-form-container">{{$children[i]}}</div>      {{~end}}    </div>  </div></div>',onPropChange:function(o,e,t,n){if("grid"!==t)return!1;var i=o.currentData,a=Number.parseInt(n),r=c("#"+i.elementId).children(".form-group").children(),s=r.children().length;if(a<s)for(let e=0;e<s-a;e++){var l=r.children(":last"),d=l.data("bsItemSortable"),d=(d&&d.destroy(),l.index());i.children&&i.children[d]&&delete i.children[d],l.find(".bs-form-container").each(function(){var e=c(this).data("bsItemSortable");e&&e.destroy()}),l.remove()}if(s<a)for(let e=0;e<a-s;e++)r.append('<div class="bs-form-container"></div>');return r.children().each(function(e,t){var n;c(this).data("bsItemSortable")||(n=new Sortable(c(this)[0],{group:"shared",animation:150,onAdd:function(e){o._onDragAdd(e)},onEnd:function(e){o._onDragEnd(e)}}),c(this).data("bsItemSortable",n))}),r.children().attr("class","bs-form-container col-"+12/Number.parseInt(n)),!0}},{name:"灵活栅格",tag:"sgrid",drag:{title:"灵活栅格",type:"container",index:100,iconClass:"bi bi-grid-1x2"},optionsCounter:2,withOptions:!0,optionsTitle:"栅格配置",opiontsAdd:function(){return{text:"栅格"+ ++this.optionsCounter,value:12}},defaultOptions:[{text:"栅格1",value:6},{text:"栅格2",value:6}],template:'<div class="bs-form-item">  <div class="form-group clearfix">    <div class="row pdlr-15">      {{~for (var i = 0;i<options.length;i++)}}      <div class="col-{{options[i].value}} bs-form-container">{{$children[i]}}</div>      {{~end}}    </div>  </div></div>',onPropChange:function(e,t,n,o){if("options"!==n||!t.children)return!1;var i={},a=t.options,r=o;for(let e=0;e<a.length;e++)i[a[e].elementId]=t.children[e];for(let e=0;e<r.length;e++){var s=r[e];t.children[e]=i[s.elementId]}}},{name:"Tab选项卡",tag:"tab",drag:{title:"Tab选项卡",type:"container",index:100,iconClass:"bi bi-menu-button"},withOptions:!0,counter:1,defaultOptions:function(e,t){var n=this.counter++,o=this.counter++;return[{text:"标签"+n,value:"tab_id_"+n},{text:"标签"+o,value:"tab_id_"+o}]},template:'<div class="bs-form-item">  <div class="form-group clearfix">    <div class="pdlr-15">      <ul class="nav nav-tabs" role="tablist">        {{~for (var i = 0;i<options.length;i++)}}        <li class="nav-item">          <a class="nav-link {{~if (i == 0)}}active {{~end}}" id="{{options[i].value}}-tab" data-toggle="tab" href="#{{options[i].value}}"            role="tab" aria-controls="{{options[i].value}}" aria-selected="{{~if(i==0)}}true{{~else}}false{{~end}}" >{{options[i].text}}</a >        </li>        {{~end}}      </ul>      <div class="tab-content">        {{~for (var i = 0;i<options.length;i++)}}        <div class="bs-form-container tab-pane fade {{~if (i == 0)}}active show {{~end}}"          id="{{options[i].value}}" role="tabpanel" aria-labelledby="{{options[i].value}}-tab" >          {{$children[i]}}        </div>        {{~end}}      </div>    </div>  </div></div>',onAdd:function(e,t){c("#"+t.elementId).find(".nav-link").on("click",function(e){return e.stopPropagation(),c(this).tab("show"),!1})},onPropChange:function(e,t,n,o){if("options"!==n||!t.children)return!1;var i={},a=t.options,r=o;for(let e=0;e<a.length;e++)i[a[e].elementId]=t.children[e];for(let e=0;e<r.length;e++){var s=r[e];t.children[e]=i[s.elementId]}}}];a.prototype={_initViewMode:function(){this._initViewStructure(),this.$container=this.$rootEl.find(".bsFormContainer"),this._initComponents(),this._initData(this.options.datas,!0),this._refreshViewContainer(),this._invokeOnInitCallback()},_initBuilderMode:function(){this._initBuilderStructure(),this.$container=this.$rootEl.find(".bsFormContainer"),this.$containerPlaceHolder=this.$rootEl.find(".placeholder-box"),this.$propsPanel=this.$rootEl.find("#component-props-content"),this._initComponents(),this._initActionButtons(),this._initDragComponents(),this._initData(this.options.datas,!0),this._refreshBuilderContainer(),this._initEvents(),this._initSortables(),this._invokeOnInitCallback()},_invokeOnInitCallback:function(){"function"==typeof this.options.onInit&&this.options.onInit(this)},_initData:function(e,t){if(e&&0!==e.length){e.sort((e,t)=>e.index-t.index);for(var n of e){var o=this.components[n.tag];if(o){if(o.props)for(const a of o.props)a.defaultValue&&!n[a.name]&&(n[a.name]=a.defaultValue);if(n.component=o,n.elementId=this.genRandomId(),n.children)for(var i of Object.values(n.children))this._initData(i,!1);t&&this.datas.push(n)}else console.warn("Can not find tag: "+n.tag)}}},_refreshViewContainer:function(){c(".bsFormContainer").children(".bs-form-item").remove();for(var e of this.datas){e=this.render(e,!1).outerHTML;this.$container.append(e)}},_initViewStructure:function(){this.$rootEl.append('<div class="row bsFormViewRoot"><div class="col-12 bsFormContainer"></div></div>')},_initBuilderStructure:function(){this.$rootEl.append('<div class="row bsFormBuilderRoot">  \x3c!--左侧拖拽区域--\x3e  <div class="col-md-3 col-sm-4">    <div class="bs-drag-panel pd10 border-right">      <ul class="nav nav-tabs mb-2" id="formTab" role="tablist">        <li class="nav-item w-50">          <a class="nav-link active" id="component-tab" data-toggle="tab" href="#component"            role="tab" aria-controls="component" aria-selected="true">表单组件</a>        </li>        <li class="nav-item w-50">          <a class="nav-link" id="module-tab"  data-toggle="tab" href="#template"            role="tab" aria-controls="module" aria-selected="false">表单模板</a>        </li>      </ul>      <div class="tab-content">        <div class="tab-pane fade show active" id="component" role="tabpanel" aria-labelledby="component-tab" >          <div class="component-title">表单组件</div>          <div class="component-group d-flex align-items-center base-drags"></div>          <div class="component-title">辅助组件</div>          <div class="component-group d-flex align-items-center assist-drags"></div>          <div class="component-title">布局组件</div>          <div class="component-group d-flex align-items-center container-drags"></div>        </div>        <div class="tab-pane fade" id="template"  role="tabpanel" aria-labelledby="module-tab">          <div id="bs-template-item-list" class="bs-template-item-list"></div>        </div>      </div>    </div>  </div>  \x3c!-- 中间内容 --\x3e  <div class="bs-container-panel col-md-6 col-sm-4">    <div class="w-100 pd10 border-bottom text-right pt-1 pb-1 bsFormActions"></div>    <div style="width: 100%;" class="bsFormContainer">      <div class="placeholder-box">从左侧拖入组件进行表单设计</div>    </div>  </div>  \x3c!-- 属性内容 --\x3e  <div class="col-md-3 col-sm-4">    <div class="bs-props-panel pd10 border-left">      <ul class="nav nav-tabs mb-2" id="formAttrTab" role="tablist">        <li class="nav-item w-50">          <a  class="nav-link active" id="component-props-tab" data-toggle="tab" href="#component-props-content"            role="tab" aria-controls="component" aria-selected="true">组件属性</a>        </li>      </ul>      <div class="tab-content pt-3">        <div class="tab-pane fade show active" id="component-props-content" role="tabpanel" aria-labelledby="component-props-tab">        </div>      </div>    </div>  </div></div>')},_initActionButtons:function(){var a=this.options.actionButtonTemplate;if(a&&""!==a){let i=this;for(let o of this.options.actionButtons||[]){let e=["$button","text","mainClass","iconClass"],t=e.map(e=>o[e]||"");t[0]=o;var r=this._renderTemplate(a,e,t);let n=c(r).attr("id",this.genRandomId());n.appendTo(".bsFormActions"),"function"==typeof o.onclick&&n.on("click",function(e){o.onclick(e,i)})}}},_initComponents:function(){var e,t=(t=this.options.useComponents)||[];for(e of s)e&&(0===t.length||-1<t.indexOf(e.tag))&&(this.components[e.tag]=e);if(window.bsComponentsDef)for(var n of window.bsComponentsDef)n&&(0===t.length||-1<t.indexOf(n.tag))&&(this.components[n.tag]=n);var o,i=this.options.components;for(o of i="function"==typeof i?i():i||[])o=c.extend(this.components[o.tag],o),this.components[o.tag]=o},_initDragComponents:function(){if(this.components&&0!==this.components.length){var e,t=[],n=[],o=[];for(e of Object.values(this.components))e&&e.drag&&e.drag.type?(e.drag.tag=e.tag,"base"===e.drag.type?t.push(e.drag):"assist"===e.drag.type?n.push(e.drag):"container"===e.drag.type&&o.push(e.drag)):console.error("Component define error! it must need drag.type. component content:",e);t.sort((e,t)=>e.index=t.index),n.sort((e,t)=>e.index=t.index),o.sort((e,t)=>e.index=t.index);var i,a=c(".base-drags");for(i of t)a.append('<ol data-tag="'+i.tag+'"><div class="component-icon"><i class="'+i.iconClass+'"></i></div><div class="form-name">'+i.title+"</div></ol>");var r,s=c(".assist-drags");for(r of n)s.append('<ol data-tag="'+r.tag+'"><div class="component-icon"><i class="'+r.iconClass+'"></i></div><div class="form-name">'+r.title+"</div></ol>");var l,d=c(".container-drags");for(l of o)d.append('<ol data-tag="'+l.tag+'"><div class="component-icon"><i class="'+l.iconClass+'"></i></div><div class="form-name">'+l.title+"</div></ol>")}},_refreshBuilderContainer:function(){if(this.$container.find(".bs-form-container").each(function(){let e=c(this).data("bsItemSortable");e&&e.destroy()}),this.$container.children(".bs-form-item").remove(),this.datas&&0!==this.datas.length){this.$containerPlaceHolder.hide();for(var e of this.datas){var t=this.render(e,!1);this._invokeComponentOnAddBefore(e,t),this.$container.append(t.outerHTML),this._invokeComponentOnAdd(e)}}else this.$containerPlaceHolder.show()},_initEvents:function(){function e(e){var t,n,o=c(this).attr("data-attr"),i=c(this).val();"array"===c(this).attr("data-type")?(n=(t=a.currentData[o]||[]).indexOf(i),"checkbox"===e.currentTarget.type&&(e.currentTarget.checked&&-1==n?t.push(i):!e.currentTarget.checked&&0<=n&&t.splice(n,1)),i=t):"checkbox"===e.currentTarget.type&&(i=e.currentTarget.checked),a.currentData?a.updateDataAttr(a.currentData,o,i):console.error("error: Current data not exits!!!")}var a=this;this.$container.on("click",".bs-form-item",function(e){e.stopPropagation(),a.makeFormItemActive(c(this).attr("id"))}),this.$container.on("click",".bs-item-copy",function(e){e.stopPropagation();e=c(this).closest(".bs-form-item").attr("id");a.copyFormItem(e)}),this.$container.on("click",".bs-item-del",function(e){e.stopPropagation();e=c(this).closest(".bs-form-item");a.deleteFormItem(e.attr("id")),a.datas&&0!==a.datas.length||a.$containerPlaceHolder.show()});this.$propsPanel.on("keyup",".onkeyup",e),this.$propsPanel.on("change",".onchange",e),this.$propsPanel.on("keyup",".option-input",function(){a._syncCurrentDataOptionsFromPropSetting()}),this.$propsPanel.on("click",".option-delete",function(e){c(this).closest(".option-item").remove(),a._syncCurrentDataOptionsFromPropSetting()}),this.$propsPanel.on("click",".option-add",function(e){var t=a.deepCopy(a.currentData.options,!1)||[],n=a.optionsCounter++,o=null;(o=(o=a.currentData.component.opiontsAdd?"function"==typeof a.currentData.component.opiontsAdd?a.currentData.component.opiontsAdd(a):a.currentData.component.opiontsAdd:o)||{text:"选项"+n,value:"value"+n}).elementId||(o.elementId=a.genRandomId()),t.push(o),a.updateDataAttr(a.currentData,"options",t),a.refreshPropsPanel()})},_initSortables:function(){var e,t=this;for(e of[".base-drags",".assist-drags",".container-drags"]){var n=document.querySelector(e);new Sortable(n,{group:{name:"shared",pull:"clone",put:!1},animation:150,sort:!1,onStart:function(e){t.$containerPlaceHolder&&t.$containerPlaceHolder.hide()},onEnd:function(e){0===t.datas.length&&t.$containerPlaceHolder.show()}})}new Sortable(document.querySelector(".bsFormContainer"),{group:"shared",animation:150,onAdd:function(e){t._onDragAdd(e)},onEnd:function(e){t._onDragEnd(e)}})},_onDragAdd:function(e){var t=null,n=c(e.item),o=n.attr("data-tag"),o=(o?(t=this.createComponentData(this.components[o]),o=this.render(t,!1),this._invokeComponentOnAddBefore(t,o),c(e.item).replaceWith(o),this._invokeComponentOnAdd(t)):t=this.getDataByElementId(n.attr("id")),this.removeDataByElementId(t.elementId),c(e.to));o.is(".bsFormContainer")?(delete t.parentDataId,delete t.parentDataIndex,this.datas.push(t)):(n=o.closest(".bs-form-item").attr("id"),e=o.closest(".bs-form-container").index(),void 0===(n=this.getDataByElementId(n)).children&&(n.children={}),void 0===n.children[e]&&(n.children[""+e]=[]),t.parentDataId=n.id,t.parentDataIndex=e,n.children[e].push(t)),this.makeFormItemActive(t.elementId),this.refreshDataIndex(o)},_invokeComponentOnAddBefore:function(e,t){e.component&&"function"==typeof e.component.onAddBefore&&e.component.onAddBefore(this,e,t)},_invokeComponentOnAdd:function(e){let t=this;c("#"+e.elementId).find(".bs-form-container").each(function(){var e;c(this).data("bsItemSortable")||(e=new Sortable(c(this)[0],{group:"shared",animation:150,onAdd:function(e){t._onDragAdd(e)},onEnd:function(e){t._onDragEnd(e)}}),c(this).data("bsItemSortable",e))}),e.component&&"function"==typeof e.component.onAdd&&e.component.onAdd(this,e)},_invokeComponentOnDelete:function(e){c("#"+e.elementId).find(".bs-form-container").each(function(){var e=c(this).data("bsItemSortable");e&&e.destroy()}),e.component&&"function"==typeof e.component.onDelete&&e.component.onDelete(this,e)},_onDragEnd:function(e){this.refreshDataIndex(c(e.from))},_getRenderMethodBody:function(e){return'let ret=""; ret += "'+e.replace(/\'/g,"&#39;").replace(/\"/g,"&quot;").replace(/[\r\n\t]/g,"").replace(/\{\{.+\&#39;*.\}\}/g,e=>e.replace(/\&#39;/g,"'")).replace(/\{\{.+\&quot;*.\}\}/g,e=>e.replace(/\&quot;/g,'"')).replace(/\{\{~\s*end\s*\}\}/g,'"}ret+="').replace(/\{\{~\s*else\s*\}\}/g,()=>'";}else{ ret+="').replace(/\{\{~\s*elseif.+?\}\}/g,e=>e.replace("elseif","}else if")).replace(/\{\{~(.+?)\}\}/g,(e,t)=>'";'+t+'{ ret+="').replace(/\{\{(.+?)\}\}/g,(e,t)=>'"; ret+= '+t+'; ret+="')+'";return ret;'},_renderTemplate:function(t,n,o){try{var e=this._getRenderMethodBody(t);return new Function(...n,e)(...o).replace(/\&#39;/g,"'").replace(/\&quot;/g,'"')}catch(e){return console.error("template error  >>>",e),console.error("template paras  >>>",n),console.error("template values >>>",o),console.error("template        >>>",t),""}},_initDataOptionsIfNecessary:function(e){var t;e.component.withOptions&&!e.options&&("function"==typeof(t=e.component.defaultOptions)&&(t=e.component.defaultOptions(this,e)),e.options=t||[],e.options.forEach(e=>{e.elementId=this.genRandomId()}),e.optionsTitle=e.component.optionsTitle||"选项")},_getPropTemplateByType:function(e){let t=this.propTemplates[e];if(t="function"==typeof t?t():t)return t;throw new Error("Not support prop type: "+e)},_syncCurrentDataOptionsFromPropSetting:function(){var i=[];this.$propsPanel.children(".options").children(".option-item").each(function(e,t){var n=c(t).children(".option-input.text").val(),o=c(t).children(".option-input.value").val(),t=c(t).attr("id");i.push({text:n,value:o,elementId:t})}),this.updateDataAttr(this.currentData,"options",i)},createComponentData:function(e){var t=e.onDataCreate&&"function"==typeof e.onDataCreate?e.onDataCreate():{};if(t.elementId=this.genRandomId(),t.id=this.genRandomId(),t.tag=e.tag,t.component=e,t.label||(t.label=e.name),t.name||(t.name=e.tag+"_"+this.componentCounter++),e.props)for(const n of e.props)n.defaultValue&&!t[n.name]&&(t[n.name]=n.defaultValue);return t},genRandomId:function(){for(var e=[],t=0;t<10;t++)e[t]="0123456789abcdef".substr(Math.floor(16*Math.random()),1);return e.join("")},renderDefault:function(t){let n=[];if("object"==typeof t.children)for(var o of Object.keys(t.children)){var i=t.children?t.children[o]:[];let e="";if(i)for(var a of i){a=this.render(a,!1);a&&(e+=a.outerHTML)}n[o]=e}var e=new Proxy(n,{get:function(e,t){return e[t]||""}}),r=(this._initDataOptionsIfNecessary(t),this.defaultProps.map(e=>e.name).concat(["value","placeholder","options"])),r=(t.component.props&&(r=r.concat(t.component.props.map(e=>e.name))),["$builder","$component","$data","$children"].concat(r)),s=r.map(e=>t[e]||"");return s[0]=this,s[1]=t.component,s[2]=t,s[3]=e,this._renderTemplate(t.component.template,r,s)},deepCopy:function(e,t){var n,o=Array.isArray(e)?[]:{};if(e&&"object"==typeof e)for(var i in e)e.hasOwnProperty(i)&&(e[i]&&"object"==typeof e[i]?o[i]=this.deepCopy(e[i],t):(n=e[i],"elementId"!==i&&"id"!==i||(n=this.genRandomId()),o[i]=n));return o},render:function(e,t){var n=e.component,o=null,o="function"==typeof n.template?n.template(n,e):n.render&&"function"==typeof n.render?n.render(this,n,e):this.renderDefault(e),n=c(o).attr("id",e.elementId);return t&&n.append('<div class="bs-item-tools">               <i class="bi bi-stickies-fill bs-item-copy" title="复制"></i>               <i class="bi bi-trash-fill bs-item-del" title="删除"></i>           </div>').addClass("active"),n[0]},makeFormItemActive:function(e){this.currentData&&this.currentData.elementId===e||(this.currentData=this.getDataByElementId(e),this.$container.find(".bs-form-item.active").removeClass("active"),this.$container.find(".bs-item-tools").remove(),c("#"+e).append('<div class="bs-item-tools">               <i class="bi bi-stickies-fill bs-item-copy" title="复制"></i>               <i class="bi bi-trash-fill bs-item-del" title="删除"></i>           </div>').addClass("active"),this.refreshPropsPanel())},deleteFormItem:function(e){this.currentData&&this.currentData.elementId===e&&(this.currentData=null,this.refreshPropsPanel());var t=this.getDataByElementId(e);t&&(this._invokeComponentOnDelete(t),delete t,this.removeDataByElementId(e),c("#"+e).remove())},copyFormItem:function(e){var t,n,o=this.getDataByElementId(e);o&&(o=this.deepCopy(o,!0),t=this.render(o,!1),n=c("#"+e),this._invokeComponentOnAddBefore(o,t),n.after(t),this._invokeComponentOnAdd(o),this.getParentArrayByElementId(e).push(o),this.refreshDataIndex(n.parent()))},getDataByElementId:function(e){return this.getDataByElementIdInArray(this.datas,e)},getDataByElementIdInArray:function(e,t){if(!e||0===e.length)return null;for(var n of e){if(n&&n.elementId===t)return n;if(n.children&&"object"==typeof n.children)for(var o of Object.values(n.children)){o=this.getDataByElementIdInArray(o,t);if(o)return o}}return null},removeDataByElementId:function(e){return this.removeDataByElementIdInArray(this.datas,e)},removeDataByElementIdInArray:function(t,n){if(t&&0!==t.length)for(let e=0;e<t.length;e++){var o=t[e];if(o&&o.elementId===n){t.splice(e,1);break}if(o.children&&"object"==typeof o.children)for(var i of Object.values(o.children))this.removeDataByElementIdInArray(i,n)}},getParentArrayByElementId:function(e){return this.getParentArrayByElementIdInArray(this.datas,e)},getParentArrayByElementIdInArray:function(t,n){if(!t||0===t.length)return null;for(let e=0;e<t.length;e++){var o=t[e];if(o&&o.elementId===n)return t;if(o.children&&"object"==typeof o.children)for(var i of Object.values(o.children)){i=this.getParentArrayByElementIdInArray(i,n);if(i)return i}}return null},refreshDataIndex:function(e){var n=this;e.children(".bs-form-item").each(function(e,t){t=c(t).attr("id");n.getDataByElementId(t).index=e})},refreshPropsPanel:function(){var n=this.$propsPanel.children(".options").data("sortable");if(n&&n.destroy(),this.$propsPanel.html(""),this.currentData){let e=this.currentData.component;var o,i,a,r,s="object"==typeof e.props?e.props:[];let t="function"==typeof e.propsfilter?e.propsfilter(this,this.currentData):"object"==typeof e.propsfilter?e.propsfilter:[];for(o of this.defaultProps.concat(s))s.indexOf(o)<0&&t&&0<t.length&&t.indexOf(o.name)<0||(i=this._getPropTemplateByType(o.type),(a=this.deepCopy(o,!1)).id=this.genRandomId(),a.value=this.currentData[o.name],a=this.renderPropTemplate(a,this.currentData,i),this.$propsPanel.append(a));(this.currentData.options||this.currentData.component.withOptions)&&(n={id:this.genRandomId(),options:this.currentData.options||[],title:this.currentData.optionsTitle||"选项"},r=this._getPropTemplateByType("options"),n=this.renderPropTemplate(n,this.currentData,r),this.$propsPanel.append(n),this._initOptionsSortable())}},_initOptionsSortable:function(){var e=this.$propsPanel.children(".options"),t=new Sortable(e[0],{handle:".option-handle",filter:".filtered",animation:150,onEnd:()=>this._syncCurrentDataOptionsFromPropSetting()});e.data("sortable",t)},renderPropTemplate:function(t,e,n){var o=c.extend({disabled:!1,required:!1,id:"",label:"",name:"",placeholder:"",type:"",value:""},t),o=["$prop","$data"].concat(Object.keys(o)),i=o.map(e=>t[e]||"");return i[0]=t,i[1]=e,this._renderTemplate(n,o,i)},exportToJson:function(){var e=this.deepCopy(this.datas,!1);return this._arrangeExportData(e),JSON.stringify(e)},exportToHtml:function(){var e,t="";for(e of this.datas)t+=this.render(e,!1).outerHTML;return t},_arrangeExportData:function(e){if(e&&0!==e.length){e.sort((e,t)=>e.index-t.index);for(var t of e)if(delete t.component,delete t.elementId,t.children)for(var n of Object.values(t.children))this._arrangeExportData(n)}},getDatas:function(){return this.datas},addDataToRoot:function(e){this.addDatasToRoot([e])},addDatasToRoot:function(e){this._initData(e,!0),this.isBuilderMode()?this._refreshBuilderContainer():this.isViewMode()&&this._refreshViewContainer()},addDataToContainer:function(e,t,n){this.addDatasToContainer([e],t,n)},addDatasToContainer:function(e,t,n){this._initData(e,!1);var o=this.getDataByElementId(t);o?(o.children||(o.children={}),o.children[n]||(o.children[n]=[]),o.children[n].push(...e),this.refreshDataElement(o)):console.error("Can not find data by elementId: "+t)},refreshDataElement:function(e){var t=this.render(e,!0),n=c("#"+e.elementId);n.find(".bs-form-container").each(function(){let e=c(this).data("bsItemSortable");e&&e.destroy()}),this._invokeComponentOnAddBefore(e,t),n.replaceWith(t),this._invokeComponentOnAdd(e)},updateDataAttr:function(e,t,n){e?("true"===(n=n&&""!==n||!e.component.defaultValue?n:e.component.defaultValue)?n=!0:"false"===n&&(n=!1),e.component&&"function"==typeof e.component.onPropChange&&e.component.onPropChange(this,e,t,n)||(e[t]=n,this.refreshDataElement(e))):console.error("data must not be null.")},isViewMode:function(){return"view"===this.options.mode},isBuilderMode:function(){return"builder"===this.options.mode},clear:function(){this.datas=[],this._refreshBuilderContainer(),this.currentData=null,this.refreshPropsPanel()},destroy:function(){this.options=null,this.defaultProps=null,this.propTemplates=null,this.useComponents=null,this.$container=null,this.$containerPlaceHolder=null,this.$propsPanel=null,this.components=null,this.datas=null,this.currentData=null,this.$rootEl.data("bsFormBuilder",null),this.$rootEl.html(""),this.$rootEl=null}},c.fn.bsFormBuilder=function(n){var o=arguments,i="object"==typeof n&&n;return this.each(function(){var e=c(this),t=e.data("bsFormBuilder");t||e.data("bsFormBuilder",t=new a(this,i)),"string"==typeof n&&((e=t[n])?1<o.length?e.apply(t,Array.prototype.slice.call(o,1)):e():console.error("bsFormBuilder has not the method: "+n))})}}(jQuery);