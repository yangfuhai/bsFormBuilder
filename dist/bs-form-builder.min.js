/*
 * bs-form-builder 1.0.0
 * A Form Builder base on JQuery and Bootstrap.
 * https://gitee.com/fuhai/bs-form-builder
 *
 * Copyright 2022, Michael <fuhai999@gmail.com>
 * Released under the LGPL license.
*/

!function(c){function i(t,e){this.options=c.extend(n,e),this.defaultProps=c.extend(a,e.props),this.propTemplates=c.extend(o,e.propTemplates),this.useComponents=e.useComponents||[],this.$rootEl=c(t),this.$container=null,this.$containerPlaceHolder=null,this.$propsPanel=null,this.components={},this.datas=[],this.currentData=null,this.componentCounter=1,"view"===this.options.mode?this._initViewMode():this._initBuilderMode()}var n={mode:"builder",useComponents:[],buttons:[{text:"导出",mainClass:"btn-primary",iconClass:"bi bi-arrow-up pr-1",onclick:""},{text:"预览",mainClass:"btn-primary",iconClass:"bi bi-eye pr-1",onclick:""},{text:"删除",mainClass:"btn-danger",iconClass:"bi bi-trash pr-1",onclick:""}],buttonTemplate:'<button type="button" class="btn btn-sm {{mainClass}}" onclick="{{onclick}}">  <i class="{{iconClass}}"></i>{{text}}</button>',templateLoadUrl:"",templateItemTemplate:'<div class="bs-template-item" id="{{id}}">  <div class="bs-template-item-image">    <img src="{{imageUrl}}" class="img-fluid" />  </div>  <div class="bs-template-item-desc">    <span class="bs-template-item-title">{{title}}</span>    <button type="button" class="btn btn-link">加载此模板</button>  </div></div>'},a=[{name:"tag",type:"input",label:"组件类型",placeholder:"",disabled:!0,required:!0},{name:"id",type:"input",label:"id",placeholder:"",disabled:!1,required:!0},{name:"name",type:"input",label:"name",placeholder:"",disabled:!1,required:!0},{name:"label",type:"input",label:"标签名",placeholder:"",disabled:!1,required:!1}],o={input:function(){return'<div class="form-group clearfix">       <div class="form-label-left">             {{~ if(required)}}             <span class="red required">*</span>             {{~end}}              <label for="{{id}}">{{label}}</label>        </div>        <div class="flex-auto">             <input id="{{id}}" type="text" data-attr="{{name}}" class="onkeyup form-control" value="{{value}}">        </div>    </div>'},select:function(){return'<div class="form-group clearfix">       <div class="form-label-left">            <legend class="col-form-label pt-0">{{label}}</legend>        </div>        <div class="flex-auto">            <select class="custom-select onchange" data-attr="{{name}}">                   {{~for (let option of options)}}                   <option value="{{option.value}}" {{~if(option.value == value)}}selected=""{{~end}}>{{option.text}}</option>                   {{~end}}             </select>        </div>    </div>'},number:function(){return'<div class="form-group clearfix">  <div class="form-label-left">    <label for="{{id}}">{{label}}</label>  </div>  <div class="flex-auto">    <input type="number" data-attr="{{name}}" class="form-control onchange onkeyup" value="{{value}}" />  </div></div>'},switch:function(){return'<div class="form-group clearfix">  <div class="form-label-left">    <legend class="col-form-label pt-0" for="{{id}}">{{label}}</legend>  </div>  <div class="flex-auto">    <div class="custom-control custom-switch">      <input type="checkbox" value="true" {{~if(value)}} checked {{~end}} data-attr="{{name}}"            class="custom-control-input onchange" id="{{id}}" />      <label class="custom-control-label" for="{{id}}"></label>    </div>  </div></div>'},checkbox:function(){return'<div class="form-group clearfix">  <div class="form-label-left">    <legend class="col-form-label pt-0">{{label}}</legend>  </div>  <div class="flex-auto">    {{~ for(let option of options)}}    <div class="form-check form-check-inline">      <input class="form-check-input onchange" {{~ if(value.indexOf(option.value) >=0 )}} checked {{~end}}            type="checkbox" data-attr="{{name}}" data-type="array"           id="{{option.value}}-{{id}}" value="{{option.value}}" />      <label class="form-check-label" for="{{option.value}}-{{id}}">{{option.text}}</label>    </div>    {{~end}}  </div></div>'},radio:function(){return'<div class="form-group clearfix">  <div class="form-label-left">    <legend class="col-form-label pt-0">{{label}}</legend>  </div>  <div class="flex-auto">    {{~ for(let option of options)}}    <div class="form-check form-check-inline">      <input class="form-check-input onchange" name="{{id}}" type="radio"            {{~ if(value == option.value )}} checked {{~end}}            data-attr="{{name}}" id="{{option.value}}-{{id}}" value="{{option.value}}" />      <label class="form-check-label" for="{{option.value}}-{{id}}">{{option.text}}</label>    </div>    {{~end}}  </div></div>'},options:function(){return'<div class="option-box options">  <div class="divider-title option-filtered">选项</div>  {{~for (let option of options)}}  <div class="form-group form-check-inline clearfix option-item">    <i class="bi bi-arrows-move pointer pr-2 option-handle"></i>    <input type="text" value="{{option.text}}" class="form-control mr-2 option-input text" />    <input type="text" value="{{option.value}}" class="form-control mr-2 option-input value" />    <i class="bi bi-dash-square pointer option-delete"></i>  </div>  {{~end}}  <div class="text-center option-filtered">    <button type="button" class="btn btn-primary btn-sm option-add">添 加</button>  </div></div>'}},r=[{name:"输入框",tag:"input",drag:{title:"输入框",type:"base",index:100,iconClass:"bi bi-terminal"},template:'<div class="bs-form-item">                   <div class="form-group clearfix">                       <div class="form-label-left">                           <label for="label">{{label}}</label>                       </div>                       <div class="flex-auto">                           <input type="text" class="form-control" id="{{id}}" placeholder="{{placeholder}}" value="{{value}}">                       </div>                   </div>               </div>'},{name:"多行输入框",tag:"textarea",drag:{title:"多行输入框",type:"base",index:100,iconClass:"bi bi-textarea-resize"},props:[{name:"rows",type:"number",label:"行数",placeholder:"请输入行数...",defaultValue:3,disabled:!1,required:!0}],template:'<div class="bs-form-item">                   <div class="form-group clearfix">                       <div class="form-label-left">                           <label for="{{id}}">{{label}}</label>                       </div>                       <div class="flex-auto">                           <textarea name="{{name}}" class="form-control" id="{{id}}" rows="{{rows}}"                                     placeholder="{{placeholder}}">{{value}}</textarea>                       </div>                   </div>               </div>'},{name:"栅格布局",tag:"grid",drag:{title:"栅格布局",type:"container",index:100,iconClass:"bi bi-textarea-resize"},props:[{name:"grid",type:"radio",label:"栅格数",defaultValue:2,options:[{value:2,text:2},{value:3,text:3},{value:4,text:4}]}],template:'<div class="bs-form-item">               <div class="form-group clearfix">                     <div class="row pdlr-15">                           {{~for (var i=0;i<$data.grid;i++)}}                           <div class="col-{{12/$data.grid}} bs-form-container">{{$children[i]}}</div>                           {{~end}}                      </div>                </div>        </div>',onAdd:function(n,t){c("#"+t.elementId).children(".form-group").children().children().each(function(t,e){c(this).attr("data-index",t),c(this).data("bsItemSortable")||(t=new Sortable(c(this)[0],{group:"shared",animation:150,onAdd:function(t){n._onDragAdd(t)},onEnd:function(t){n._onDragEnd(t)}}),c(this).data("bsItemSortable",t))})},onPropChange:function(n,t,e,a){if("grid"!==e)return!1;var o=n.currentData,i=Number.parseInt(a),r=c("#"+o.elementId).children(".form-group").children(),s=r.children().length;if(i<s)for(let t=0;t<s-i;t++){var l=r.children(":last"),d=l.data("bsItemSortable"),d=(d&&d.destroy(),l.attr("data-index"));o.children&&o.children[d]&&delete o.children[d],l.remove()}if(s<i)for(let t=0;t<i-s;t++)r.append('<div class="bs-form-container"></div>');return r.children().each(function(t,e){c(this).attr("data-index",t),c(this).data("bsItemSortable")||(t=new Sortable(c(this)[0],{group:"shared",animation:150,onAdd:function(t){n._onDragAdd(t)},onEnd:function(t){n._onDragEnd(t)}}),c(this).data("bsItemSortable",t))}),r.children().attr("class","bs-form-container col-"+12/Number.parseInt(a)),!0}}];i.prototype={_initViewMode:function(){this._initViewStructure(),this.$container=this.$rootEl.find(".bsFormContainer"),this._initComponents(),this._initData(this.options.datas,!0),this._refreshViewContainer(),this._invokeOnInitCallback()},_initBuilderMode:function(){this._initBuilderStructure(),this.$container=this.$rootEl.find(".bsFormContainer"),this.$containerPlaceHolder=this.$rootEl.find(".placeholder-box"),this.$propsPanel=this.$rootEl.find("#component-props-content"),this._initComponents(),this._initFormActionButtons(),this._initDragComponents(),this._initData(this.options.datas,!0),this._refreshBuilderContainer(),this._initEvents(),this._initSortables(),this._invokeOnInitCallback()},_invokeOnInitCallback:function(){"function"==typeof this.options.onInit&&this.options.onInit(this)},_initData:function(t,e){if(t&&0!==t.length){t.sort((t,e)=>t.index-e.index);for(var n of t){var a=this.components[n.tag];if(a){if(a.props)for(const i of a.props)i.defaultValue&&!n[i.name]&&(n[i.name]=i.defaultValue);if(n.component=a,n.elementId=this.genRandomId(),n.children)for(var o of Object.values(n.children))this._initData(o,!1);e&&this.datas.push(n)}else console.warn("Can not find tag: "+n.tag)}}},_refreshViewContainer:function(){c(".bsFormContainer").children(".bs-form-item").remove();for(var t of this.datas){t=this.render(t,!1).outerHTML;this.$container.append(t)}},_initViewStructure:function(){this.$rootEl.append('<div class="row bsFormViewRoot"><div class="col-12 bsFormContainer"></div></div>')},_initBuilderStructure:function(){this.$rootEl.append(' <div class="row bsFormBuilderRoot">            \x3c!--左侧拖拽区域--\x3e            <div class="col-md-3 col-sm-4 ">                <div class="bs-drag-panel pd10 border-right">                    <ul class="nav nav-tabs mb-2" id="formTab" role="tablist">                        <li class="nav-item w-50">                            <a class="nav-link active" id="component-tab" data-toggle="tab" href="#component" role="tab"                               aria-controls="component" aria-selected="true">表单组件</a>                        </li>                        <li class="nav-item w-50">                            <a class="nav-link" id="module-tab" data-toggle="tab" href="#template" role="tab"                               aria-controls="module" aria-selected="false">表单模板</a>                        </li>                    </ul>                    <div class="tab-content">                        <div class="tab-pane fade show active" id="component" role="tabpanel"                             aria-labelledby="component-tab">                            <div class="component-title">                                表单组件                            </div>                            <div class="component-group d-flex align-items-center base-drags">                            </div>                            <div class="component-title">                                辅助组件                            </div>                            <div class="component-group d-flex align-items-center assist-drags">                            </div>                            <div class="component-title">                                布局组件                            </div>                            <div class="component-group d-flex align-items-center container-drags">                            </div>                        </div>                        <div class="tab-pane fade" id="template" role="tabpanel" aria-labelledby="module-tab">                            <div id="bs-template-item-list" class="bs-template-item-list">                            </div>                        </div>                    </div>                </div>            </div>            \x3c!-- 中间内容 --\x3e            <div class="bs-container-panel col-md-6  col-sm-4">                <div class="w-100 pd10 border-bottom text-right pt-1 pb-1 bsFormActions">                </div>                <div style="width: 100%;" class="bsFormContainer">                    <div class="placeholder-box">从左侧拖入组件进行表单设计</div>                </div>            </div>            \x3c!-- 属性内容 --\x3e            <div class="col-md-3  col-sm-4">                <div class="bs-props-panel pd10 border-left">                    <ul class="nav nav-tabs mb-2" id="formAttrTab" role="tablist">                        <li class="nav-item w-50">                            <a class="nav-link active" id="component-props-tab" data-toggle="tab"                               href="#component-props-content"                               role="tab" aria-controls="component" aria-selected="true">组件属性</a>                        </li>                    </ul>                    <div class="tab-content pt-3">                        <div class="tab-pane fade show active" id="component-props-content" role="tabpanel"                             aria-labelledby="component-props-tab">                        </div>                    </div>                </div>            </div>        </div>')},_initFormActionButtons:function(){var t=this.options.buttonTemplate;if(t&&""!==t){var a=this._getRenderMethodBody(t);for(let n of this.options.buttons||[]){let t=["$button","text","mainClass","iconClass","onclick"],e=t.map(t=>n[t]||"");e[0]=n;var o=this._invokeRenderBody(a,t,e);c(".bsFormActions").append(o)}}},_initComponents:function(){var t,e=(e=this.options.useComponents)||[];for(t of r)t&&(0===e.length||-1<e.indexOf(t.tag))&&(this.components[t.tag]=t);if(window.bsComponentsDef)for(var n of window.bsComponentsDef)n&&(0===e.length||-1<e.indexOf(n.tag))&&(this.components[n.tag]=n);var a,o=this.options.components;for(a of o="function"==typeof o?o():o||[])a=c.extend(this.components[a.tag],a),this.components[a.tag]=a},_initDragComponents:function(){if(this.components&&0!==this.components.length){var t,e=[],n=[],a=[];for(t of Object.values(this.components))t&&t.drag&&t.drag.type?(t.drag.tag=t.tag,"base"===t.drag.type?e.push(t.drag):"assist"===t.drag.type?n.push(t.drag):"container"===t.drag.type&&a.push(t.drag)):console.error("Component define error! it must need drag.type. component content:",t);e.sort((t,e)=>t.index=e.index),n.sort((t,e)=>t.index=e.index),a.sort((t,e)=>t.index=e.index);var o,i=c(".base-drags");for(o of e)i.append('<ol data-tag="'+o.tag+'"><div class="component-icon"><i class="'+o.iconClass+'"></i></div><div class="form-name">'+o.title+"</div></ol>");var r,s=c(".assist-drags");for(r of n)s.append('<ol data-tag="'+r.tag+'"><div class="component-icon"><i class="'+r.iconClass+'"></i></div><div class="form-name">'+r.title+"</div></ol>");var l,d=c(".container-drags");for(l of a)d.append('<ol data-tag="'+l.tag+'"><div class="component-icon"><i class="'+l.iconClass+'"></i></div><div class="form-name">'+l.title+"</div></ol>")}},_refreshBuilderContainer:function(){if(c(".bsFormContainer").children(".bs-form-item").remove(),this.datas&&0!==this.datas.length){this.$containerPlaceHolder.hide();for(var t of this.datas){var e=this.render(t,!1).outerHTML;this.$container.append(e),this._invokeComponentOnAdd(t)}}else this.$containerPlaceHolder.show()},_initEvents:function(){function t(t){var e,n,a=c(this).attr("data-attr"),o=c(this).val();"array"===c(this).attr("data-type")?(n=(e=i.currentData[a]||[]).indexOf(o),"checkbox"===t.currentTarget.type&&(t.currentTarget.checked&&-1==n?e.push(o):!t.currentTarget.checked&&0<=n&&e.splice(n,1)),o=e):"checkbox"===t.currentTarget.type&&(o=t.currentTarget.checked),i.currentData?i.updateDataAttr(i.currentData,a,o):console.error("error: Current data not exits!!!")}var i=this;c(".bsFormContainer").on("click",".bs-form-item",function(t){console.log("bs-form-item click >>>>>>",t),t.stopPropagation(),i.makeFormItemActive(c(this).attr("id"))}),c(".bsFormContainer").on("click",".bs-item-copy",function(t){t.stopPropagation();t=c(this).closest(".bs-form-item").attr("id");i.copyFormItem(t)}),c(".bsFormContainer").on("click",".bs-item-del",function(t){t.stopPropagation();t=c(this).closest(".bs-form-item");i.deleteFormItem(t.attr("id"))});this.$propsPanel.on("keyup",".onkeyup",t),this.$propsPanel.on("change",".onchange",t),this.$propsPanel.on("keyup",".option-input",function(){i._syncCurrentDataOptionsFromPropSetting()}),this.$propsPanel.on("click",".option-delete",function(t){c(this).closest(".option-item").remove(),i._syncCurrentDataOptionsFromPropSetting()}),this.$propsPanel.on("click",".option-add",function(t){var e=i.currentData.options||[];e.push({text:"选项",value:"值"}),i.updateDataAttr(i.currentData,"options",e),i.refreshPropsPanel()})},_initSortables:function(){var t,e=this;for(t of[".base-drags",".assist-drags",".container-drags"]){var n=document.querySelector(t);new Sortable(n,{group:{name:"shared",pull:"clone",put:!1},animation:150,sort:!1,onStart:function(t){e.$containerPlaceHolder&&e.$containerPlaceHolder.hide()},onEnd:function(t){0===e.datas.length&&e.$containerPlaceHolder.show()}})}new Sortable(document.querySelector(".bsFormContainer"),{group:"shared",animation:150,onAdd:function(t){e._onDragAdd(t)},onEnd:function(t){e._onDragEnd(t)}})},_onDragAdd:function(t){console.log(">>>> onDragAdd: ",t,this);var e=null,n=c(t.item),a=n.attr("data-tag"),a=(a?(e=this.createComponentData(this.components[a]),a=this.render(e,!1),c(t.item).replaceWith(a)):e=this.getDataByElementId(n.attr("id")),this.removeDataByElementId(e.elementId),c(t.to));a.is(".bsFormContainer")?(delete e.parentDataId,delete e.parentDataIndex,this.datas.push(e)):(n=a.closest(".bs-form-item").attr("id"),t=a.closest(".bs-form-container").attr("data-index"),void 0===(n=this.getDataByElementId(n)).children&&(n.children={}),void 0===n.children[t]&&(n.children[""+t]=[]),e.parentDataId=n.id,e.parentDataIndex=t,n.children[t].push(e)),this._invokeComponentOnAdd(e),this.makeFormItemActive(e.elementId),this.refreshDataIndex(a)},_invokeComponentOnAdd:function(t){t.component&&"function"==typeof t.component.onAdd&&t.component.onAdd(this,t)},_onDragEnd:function(t){this.refreshDataIndex(c(t.from))},_getRenderMethodBody:function(t){return'let ret=""; ret += "'+t.replace(/\'/g,"&#39;").replace(/\"/g,"&quot;").replace(/[\r\n\t]/g,"").replace(/\{\{.+\&#39;*.\}\}/g,t=>t.replace(/\&#39;/g,"'")).replace(/\{\{.+\&quot;*.\}\}/g,t=>t.replace(/\&quot;/g,'"')).replace(/\{\{~\s*end\s*\}\}/g,'"}ret+="').replace(/\{\{~\s*else\s*\}\}/g,()=>'";}else{ ret+="').replace(/\{\{~\s*elseif.+?\}\}/g,t=>t.replace("elseif","}else if")).replace(/\{\{~(.+?)\}\}/g,(t,e)=>'";'+e+'{ ret+="').replace(/\{\{(.+?)\}\}/g,(t,e)=>'"; ret+= '+e+'; ret+="')+'";return ret;'},_invokeRenderBody:function(t,e,n){try{return new Function(...e,t)(...n).replace(/\&#39;/g,"'").replace(/\&quot;/g,'"')}catch(t){return console.error("template error >>>",t),console.error("template >>>",template),""}},_initDataOptionsIfNecessary:function(t){var e;t.component.withOptions&&!t.options&&("function"==typeof(e=t.component.defaultOptions)&&(e=t.component.defaultOptions(this,t)),t.options=e||[])},_getPropTemplateByType:function(t){let e=this.propTemplates[t];return e="function"==typeof e?e():e},_syncCurrentDataOptionsFromPropSetting:function(){var a=[];this.$propsPanel.children(".options").children(".option-item").each(function(t,e){var n=c(e).children(".option-input.text").val(),e=c(e).children(".option-input.value").val();a.push({text:n,value:e})}),this.updateDataAttr(this.currentData,"options",a)},createComponentData:function(t){var e=t.onDataCreate&&"function"==typeof t.onDataCreate?t.onDataCreate():{};if(e.elementId=this.genRandomId(),e.id=this.genRandomId(),e.tag=t.tag,e.component=t,e.label||(e.label=t.name),e.name||(e.name=t.tag+"_"+this.componentCounter++),t.props)for(const n of t.props)n.defaultValue&&!e[n.name]&&(e[n.name]=n.defaultValue);return e},genRandomId:function(){for(var t=[],e=0;e<10;e++)t[e]="0123456789abcdef".substr(Math.floor(16*Math.random()),1);return t.join("")},renderDefault:function(e){let n=[];if("object"==typeof e.children)for(var a of Object.keys(e.children)){var o=e.children?e.children[a]:[];let t="";if(o)for(var i of o){i=this.render(i,!1);i&&(t+=i.outerHTML)}n[a]=t}var t=new Proxy(n,{get:function(t,e){return t[e]||""}}),r=this._getRenderMethodBody(e.component.template),s=(this._initDataOptionsIfNecessary(e),this.defaultProps.map(t=>t.name).concat(["value","placeholder","options"])),s=(e.component.props&&(s=s.concat(e.component.props.map(t=>t.name))),["$builder","$component","$data","$children"].concat(s)),l=s.map(t=>e[t]||"");return l[0]=this,l[1]=e.component,l[2]=e,l[3]=t,this._invokeRenderBody(r,s,l)},deepCopy:function(t,e){var n,a=Array.isArray(t)?[]:{};if(t&&"object"==typeof t)for(var o in t)t.hasOwnProperty(o)&&(t[o]&&"object"==typeof t[o]?a[o]=this.deepCopy(t[o],e):(n=t[o],"elementId"!==o&&"id"!==o||(n=this.genRandomId()),a[o]=n));return a},render:function(t,e){var n=t.component,a=null,a="function"==typeof n.template?n.template(n,t):n.render&&"function"==typeof n.render?n.render(this,n,t):this.renderDefault(t),n=c(a).attr("id",t.elementId);return e&&n.append('<div class="bs-item-tools">               <i class="bi bi-card-image bs-item-copy" title="复制"></i>               <i class="bi bi-trash bs-item-del" title="删除"></i>           </div>').addClass("active"),n[0]},makeFormItemActive:function(t){this.currentData&&this.currentData.elementId===t||(this.currentData=this.getDataByElementId(t),this.$container.find(".bs-form-item.active").removeClass("active"),this.$container.find(".bs-item-tools").remove(),c("#"+t).append('<div class="bs-item-tools">               <i class="bi bi-card-image bs-item-copy" title="复制"></i>               <i class="bi bi-trash bs-item-del" title="删除"></i>           </div>').addClass("active"),this.refreshPropsPanel())},deleteFormItem:function(t){this.currentData&&this.currentData.elementId===t&&(this.currentData=null,this.refreshPropsPanel()),this.removeDataByElementId(t),c("#"+t).remove()},copyFormItem:function(t){var e,n,a=this.getDataByElementId(t);a&&(a=this.deepCopy(a,!0),e=this.render(a,!1),(n=c("#"+t)).after(e),this._invokeComponentOnAdd(a),this.getParentArrayByElementId(t).push(a),this.refreshDataIndex(n.parent()))},getDataByElementId:function(t){return this.getDataByElementIdInArray(this.datas,t)},getDataByElementIdInArray:function(t,e){if(!t||0===t.length)return null;for(var n of t){if(n&&n.elementId===e)return n;if(n.children&&"object"==typeof n.children)for(var a of Object.values(n.children)){a=this.getDataByElementIdInArray(a,e);if(a)return a}}return null},removeDataByElementId:function(t){return this.removeDataByElementIdInArray(this.datas,t)},removeDataByElementIdInArray:function(e,n){if(e&&0!==e.length)for(let t=0;t<e.length;t++){var a=e[t];if(a&&a.elementId===n){e.splice(t,1);break}if(a.children&&"object"==typeof a.children)for(var o of Object.values(a.children))this.removeDataByElementIdInArray(o,n)}},getParentArrayByElementId:function(t){return this.getParentArrayByElementIdInArray(this.datas,t)},getParentArrayByElementIdInArray:function(e,n){if(!e||0===e.length)return null;for(let t=0;t<e.length;t++){var a=e[t];if(a&&a.elementId===n)return e;if(a.children&&"object"==typeof a.children)for(var o of Object.values(a.children)){o=this.getParentArrayByElementIdInArray(o,n);if(o)return o}}return null},refreshDataIndex:function(t){var n=this;t.children(".bs-form-item").each(function(t,e){e=c(e).attr("id");n.getDataByElementId(e).index=t})},refreshPropsPanel:function(){if(this.currentData){let t=this.currentData.component;var n,a,o,i,r=this.$propsPanel.children(".options").data("sortable"),s=(r&&r.destroy(),this.$propsPanel.html(""),"object"==typeof t.props?t.props:[]);let e="function"==typeof t.propsfilter?t.propsfilter(this,this.currentData):"object"==typeof t.propsfilter?t.propsfilter:[];for(n of this.defaultProps.concat(s))s.indexOf(n)<0&&e&&0<e.length&&e.indexOf(n.name)<0||(a=this._getPropTemplateByType(n.type),(o=this.deepCopy(n,!1)).id=this.genRandomId(),o.value=this.currentData[n.name],o=this.renderPropTemplate(o,this.currentData,a),this.$propsPanel.append(o));(this.currentData.options||this.currentData.component.withOptions)&&(r={id:this.genRandomId(),options:this.currentData.options||[]},i=this._getPropTemplateByType("options"),r=this.renderPropTemplate(r,this.currentData,i),this.$propsPanel.append(r),this._initOptionsSortable())}},_initOptionsSortable:function(){var t=this.$propsPanel.children(".options"),e=new Sortable(t[0],{handle:".option-handle",filter:".filtered",animation:150,onEnd:()=>this._syncCurrentDataOptionsFromPropSetting()});t.data("sortable",e)},renderPropTemplate:function(e,t,n){var n=this._getRenderMethodBody(n),a=["$prop","$data"].concat(Object.keys(e)),o=a.map(t=>e[t]||"");return o[0]=e,o[1]=t,this._invokeRenderBody(n,a,o)},exportToJson:function(){var t=this.deepCopy(this.datas,!1);return this._arrangeExportData(t),JSON.stringify(t)},_arrangeExportData:function(t){if(t&&0!==t.length){t.sort((t,e)=>t.index-e.index);for(var e of t)if(delete e.component,delete e.elementId,e.children)for(var n of Object.values(e.children))this._arrangeExportData(n)}},getDatas:function(){return this.datas},addDataToRoot:function(t){this.addDatasToRoot([t])},addDatasToRoot:function(t){this._initData(t,!0),this.isBuilderMode()?this._refreshBuilderContainer():this.isViewMode()&&this._refreshViewContainer()},addDataToContainer:function(t,e,n){this.addDatasToContainer([t],e,n)},addDatasToContainer:function(t,e,n){this._initData(t,!1);var a=this.getDataByElementId(e);a?(a.children||(a.children={}),a.children[n]||(a.children[n]=[]),a.children[n].push(...t),this.refreshDataElement(a)):console.error("Can not find data by elementId: "+e)},refreshDataElement:function(t){var e=this.render(t,!0);c("#"+t.elementId).replaceWith(e)},updateDataAttr:function(t,e,n){t?("true"===(n=n&&""!==n||!t.component.defaultValue?n:t.component.defaultValue)?n=!0:"false"===n&&(n=!1),t[e]=n,t.component&&"function"==typeof t.component.onPropChange&&t.component.onPropChange(this,t,e,n)||this.refreshDataElement(t)):console.error("data must not be null.")},isViewMode:function(){return"view"===this.options.mode},isBuilderMode:function(){return"builder"===this.options.mode}},c.fn.bsFormBuilder=function(n){var a=arguments,o="object"==typeof n&&n;return this.each(function(){var t=c(this),e=t.data("bsFormBuilder");e||t.data("bsFormBuilder",e=new i(this,o)),"string"==typeof n&&((t=e[n])?1<a.length?t.apply(e,Array.prototype.slice.call(a,1)):t():console.error("BsFormBuilder has not the method: "+n))})}}(jQuery);