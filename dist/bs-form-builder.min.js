/*
 * bs-form-builder 1.0.0
 * A Form Builder base on JQuery and Bootstrap.
 * https://gitee.com/fuhai/bs-form-builder
 *
 * Copyright 2022, Michael <fuhai999@gmail.com>
 * Released under the LGPL license.
*/

!function(c){function o(e,t){this.options=c.extend(n,t),this.defaultProps=c.extend(a,t.props),this.propTemplates=c.extend(i,t.propTemplates),this.useComponents=t.useComponents||[],this.$rootEl=c(e),this.$container=null,this.$containerPlaceHolder=null,this.$propsPanel=null,this.components={},this.datas=[],this.currentData=null,this.componentCounter=1,"view"===this.options.mode?this._initViewMode():this._initBuilderMode()}var n={mode:"builder",useComponents:[]},a=[{name:"tag",type:"input",label:"组件类型",placeholder:"",disabled:!0,required:!0},{name:"id",type:"input",label:"id",placeholder:"",disabled:!1,required:!0},{name:"name",type:"input",label:"name",placeholder:"",disabled:!1,required:!0},{name:"label",type:"input",label:"标签名",placeholder:"",disabled:!1,required:!1}],i={input:function(){return'<div class="form-group clearfix">       <div class="form-label-left">             <span class="red required">*</span>              <label></label>        </div>        <div class="flex-auto">             <input type="text" class="form-control">        </div>    </div>'},select:function(){},number:function(){},switch:function(){},checkbox:function(){},radio:function(){}},r=[{name:"输入框",tag:"input",drag:{title:"输入框",type:"base",index:100,iconClass:"bi bi-terminal"},props:[],template:'<div class="bs-form-item">                   <div class="form-group clearfix">                       <div class="form-label-left">                           <label for="label">{{label}}</label>                       </div>                       <div class="flex-auto">                           <input type="text" class="form-control" id="{{id}}" placeholder="{{placeholder}}" value="{{value}}">                       </div>                   </div>               </div>'},{name:"多行输入框",tag:"textarea",drag:{title:"多行输入框",type:"base",index:100,iconClass:"bi bi-textarea-resize"},props:[{name:"rows",type:"input",label:"行数",placeholder:"请输入行数...",defaultValue:5,disabled:!1,required:!0}],template:'<div class="bs-form-item">                   <div class="form-group clearfix">                       <div class="form-label-left">                           <label for="{{id}}">{{label}}</label>                       </div>                       <div class="flex-auto">                           <textarea name="{{name}}" class="form-control" id="{{id}}" rows="{{rows}}"                                     placeholder="{{placeholder}}">{{value}}</textarea>                       </div>                   </div>               </div>'},{name:"栅格布局",tag:"grid",drag:{title:"栅格布局",type:"container",index:100,iconClass:"bi bi-textarea-resize"},props:[{name:"grid",type:"input",label:"栅格数",placeholder:"请输入行数...",defaultValue:2,disabled:!1,required:!0}],template:'<div class="bs-form-item">               <div class="form-group clearfix">                     <div class="row pdlr-15">                           {{~for (var i=0;i<$data.grid;i++)}}                           <div class="col-{{12/$data.grid}} bs-form-container">{{$children[i]}}</div>                           {{~end}}                      </div>                </div>        </div>',onAdd:function(n,e){c("#"+e.elementId).children(".form-group").children().children().each(function(e,t){c(this).attr("data-index",e),c(this).data("bsItemSortable")||(e=new Sortable(c(this)[0],{group:"shared",animation:150,onAdd:function(e){n._onDragAdd(e)},onEnd:function(e){n._onDragEnd(e)}}),c(this).data("bsItemSortable",e))})},onPropChange:function(n,e,t,a){if("grid"!==t)return!1;var i=n.currentData,o=Number.parseInt(a),r=c("#"+i.elementId).children(".form-group").children(),s=r.children().length;if(o<s)for(let e=0;e<s-o;e++){var l=r.children(":last"),d=l.data("bsItemSortable"),d=(d&&d.destroy(),l.attr("data-index"));i.children&&i.children[d]&&delete i.children[d],l.remove()}if(s<o)for(let e=0;e<o-s;e++)r.append('<div class="bs-form-container"></div>');return r.children().each(function(e,t){c(this).attr("data-index",e),c(this).data("bsItemSortable")||(e=new Sortable(c(this)[0],{group:"shared",animation:150,onAdd:function(e){n._onDragAdd(e)},onEnd:function(e){n._onDragEnd(e)}}),c(this).data("bsItemSortable",e))}),r.children().attr("class","bs-form-container col-"+12/Number.parseInt(a)),!0}}];o.prototype={_initViewMode:function(){this._initViewStructure(),this.$container=this.$rootEl.find(".bsFormContainer"),this._initComponents(),this._initData(this.options.datas,!0),this._refreshViewContainer(),this._invokeOnInitCallback()},_initBuilderMode:function(){this._initBuilderStructure(),this.$container=this.$rootEl.find(".bsFormContainer"),this.$containerPlaceHolder=this.$rootEl.find(".placeholder-box"),this.$propsPanel=this.$rootEl.find("#component-props-content"),this._initComponents(),this._initDragComponents(),this._initData(this.options.datas,!0),this._refreshBuilderContainer(),this._initEvents(),this._initSortables(),this._invokeOnInitCallback()},_invokeOnInitCallback:function(){"function"==typeof this.options.onInit&&this.options.onInit(this)},_initData:function(e,t){if(e&&0!==e.length){e.sort((e,t)=>e.index-t.index);for(var n of e){var a=this.components[n.tag];if(a){if(a.props)for(const o of a.props)o.defaultValue&&!n[o.name]&&(n[o.name]=o.defaultValue);if(n.component=a,n.elementId=this.genRandomId(),n.children)for(var i of Object.values(n.children))this._initData(i,!1);t&&this.datas.push(n)}else console.warn("Can not find tag: "+n.tag)}}},_refreshViewContainer:function(){c(".bsFormContainer").children(".bs-form-item").remove();for(var e of this.datas){e=this.render(e,!1).outerHTML;this.$container.append(e)}},_initViewStructure:function(){this.$rootEl.append('<div class="row bsFormViewRoot"><div class="col-12 bsFormContainer"></div></div>')},_initBuilderStructure:function(){this.$rootEl.append(' <div class="row bsFormBuilderRoot">            \x3c!--左侧拖拽区域--\x3e            <div class="col-md-3 col-sm-4 ">                <div class="bs-drag-panel pd10 border-right">                    <ul class="nav nav-tabs mb-2" id="formTab" role="tablist">                        <li class="nav-item w-50">                            <a class="nav-link active" id="component-tab" data-toggle="tab" href="#component" role="tab"                               aria-controls="component" aria-selected="true">表单组件</a>                        </li>                        <li class="nav-item w-50">                            <a class="nav-link" id="module-tab" data-toggle="tab" href="#template" role="tab"                               aria-controls="module" aria-selected="false">表单模板</a>                        </li>                    </ul>                    <div class="tab-content">                        <div class="tab-pane fade show active" id="component" role="tabpanel"                             aria-labelledby="component-tab">                            <div class="component-title">                                表单组件                            </div>                            <div class="component-group d-flex align-items-center base-drags">                            </div>                            <div class="component-title">                                辅助组件                            </div>                            <div class="component-group d-flex align-items-center assist-drags">                            </div>                            <div class="component-title">                                布局组件                            </div>                            <div class="component-group d-flex align-items-center container-drags">                            </div>                        </div>                        <div class="tab-pane fade" id="template" role="tabpanel" aria-labelledby="module-tab">                            <div id="item-list" class="item-list">                                <div class="text-center">没有更多了</div>                            </div>                        </div>                    </div>                </div>            </div>            \x3c!-- 中间内容 --\x3e            <div class="bs-container-panel col-md-6  col-sm-4">                <div class="w-100 pd10 border-bottom text-right pt-1 pb-1">                    <button type="button" class="btn btn-primary btn-sm btn-export mr-2">                        <i class="bi bi-box-arrow-in-up pr-1"></i>导出                    </button>                    <button type="button" class="btn btn-primary btn-sm btn-import mr-2">                        <i class="bi bi-box-arrow-in-down pr-1"></i>导入                    </button>                    <button type="button" class="btn btn-primary btn-sm btn-component mr-2">                        <i class="bi bi-eye pr-1"></i>预览                    </button>                    <button type="button" class="btn btn-sm btn-danger btn-clear">                        <i class="bi bi-trash pr-1"></i>清空                    </button>                </div>                <div style="width: 100%;" class="bsFormContainer">                    <div class="placeholder-box">从左侧拖入组件进行表单设计</div>                </div>            </div>            \x3c!-- 属性内容 --\x3e            <div class="col-md-3  col-sm-4">                <div class="bs-props-panel pd10 border-left">                    <ul class="nav nav-tabs mb-2" id="formAttrTab" role="tablist">                        <li class="nav-item w-50">                            <a class="nav-link active" id="component-props-tab" data-toggle="tab"                               href="#component-props-content"                               role="tab" aria-controls="component" aria-selected="true">组件属性</a>                        </li>                        <li class="nav-item w-50">                            <a class="nav-link" id="form-props-tab" data-toggle="tab"                               href="#form-props-content"                               role="tab"                               aria-controls="module" aria-selected="false">表单属性</a>                        </li>                    </ul>                    <div class="tab-content pt-3">                        <div class="tab-pane fade show active" id="component-props-content" role="tabpanel"                             aria-labelledby="component-props-tab">                        </div>                        <div class="tab-pane fade" id="form-props-content" role="tabpanel"                             aria-labelledby="form-props-tab">                              <div class="form-group clearfix">                                    <div class="form-label-left">                                        <span class="red">*</span>                                        <label for="formItemId">表单id</label>                                    </div>                                    <div class="flex-auto">                                        <input type="text" class="form-control" id="formItemId" value="formItem"                                               disabled>                                    </div>                            </div>                            <div class="form-group clearfix">                                <div class="form-label-left">                                    <label for="label">表单类型</label>                                </div>                                <div class="flex-auto">                                    <div class="form-check form-check-inline">                                        <input class="form-check-input" type="radio" name="formtype" id="radio1"                                               value="option1" checked>                                        <label class="form-check-label" for="radio1">内置</label>                                    </div>                                    <div class="form-check form-check-inline">                                        <input class="form-check-input" type="radio" name="formtype" id="radio2"                                               value="option2">                                        <label class="form-check-label" for="radio2">弹窗</label>                                    </div>                                </div>                            </div>                            <div class="form-group clearfix">                                <div class="form-label-left">                                    <label for="label">表单按钮</label>                                </div>                                <div class="flex-auto">                                    <div class="form-check form-check-inline">                                        <input class="form-check-input" type="radio" name="postBtn" id="radioBtn1"                                               value="option1" checked>                                        <label class="form-check-label" for="radioBtn1">开启</label>                                    </div>                                    <div class="form-check form-check-inline">                                        <input class="form-check-input" type="radio" name="postBtn" id="radioBtn2"                                               value="option2">                                        <label class="form-check-label" for="radioBtn2">关闭</label>                                    </div>                                </div>                            </div>                            <div class="form-group clearfix">                                <div class="form-label-left">                                    <label for="name">表单宽度</label>                                </div>                                <div class="flex-auto">                                    <input type="number" min="1" class="form-control jp-range"                                           value="254">                                    <span>-</span>                                    <input type="number" min="1" class="form-control jp-range"                                           value="254">                                </div>                            </div>                        </div>                    </div>                </div>            </div>        </div>')},_initComponents:function(){var e,t,n=(n=this.options.useComponents)||[],a=this.options.components&&"object"==typeof this.options.components?this.options.components:[];for(e of r)e&&(0===n.length||-1<n.indexOf(e.tag))&&(this.components[e.tag]=e);if(window.bsComponentsDef)for(var i of window.bsComponentsDef)i&&(0===n.length||-1<n.indexOf(i.tag))&&(this.components[i.tag]=i);for(t of a)t&&(0===n.length||-1<n.indexOf(t.tag))&&(this.components[t.tag]=t)},_initDragComponents:function(){if(this.components&&0!==this.components.length){var e,t=[],n=[],a=[];for(e of Object.values(this.components))e&&e.drag&&e.drag.type?(e.drag.tag=e.tag,"base"===e.drag.type?t.push(e.drag):"assist"===e.drag.type?n.push(e.drag):"container"===e.drag.type&&a.push(e.drag)):console.error("Component define error! it must need drag.type. component content:",e);t.sort((e,t)=>e.index=t.index),n.sort((e,t)=>e.index=t.index),a.sort((e,t)=>e.index=t.index);var i,o=c(".base-drags");for(i of t)o.append('<ol data-tag="'+i.tag+'"><div class="component-icon"><i class="'+i.iconClass+'"></i></div><div class="form-name">'+i.title+"</div></ol>");var r,s=c(".assist-drags");for(r of n)s.append('<ol data-tag="'+r.tag+'"><div class="component-icon"><i class="'+r.iconClass+'"></i></div><div class="form-name">'+r.title+"</div></ol>");var l,d=c(".container-drags");for(l of a)d.append('<ol data-tag="'+l.tag+'"><div class="component-icon"><i class="'+l.iconClass+'"></i></div><div class="form-name">'+l.title+"</div></ol>")}},_refreshBuilderContainer:function(){if(c(".bsFormContainer").children(".bs-form-item").remove(),this.datas&&0!==this.datas.length){this.$containerPlaceHolder.hide();for(var e of this.datas){var t=this.render(e,!1).outerHTML;this.$container.append(t),this._invokeComponentOnAdd(e)}}else this.$containerPlaceHolder.show()},_initEvents:function(){var a=this;c(".bsFormContainer").on("click",".bs-form-item",function(e){console.log("bs-form-item click >>>>>>",e),e.stopPropagation(),a.makeFormItemActive(c(this).attr("id"))}),c(".bsFormContainer").on("click",".bs-item-copy",function(e){e.stopPropagation();e=c(this).closest(".bs-form-item").attr("id");a.copyFormItem(e)}),c(".bsFormContainer").on("click",".bs-item-del",function(e){e.stopPropagation();e=c(this).closest(".bs-form-item");a.deleteFormItem(e.attr("id"))}),c("#component-props-content").on("keyup","  .form-control",function(e){var t=c(this).attr("data-attr"),n=c(this).val();a.currentData?a.updateDataAttr(a.currentData,t,n):console.error("error: Current data not exits!!!")})},_initSortables:function(){var e,t=this;for(e of[".base-drags",".assist-drags",".container-drags"]){var n=document.querySelector(e);new Sortable(n,{group:{name:"shared",pull:"clone",put:!1},animation:150,sort:!1,onStart:function(e){t.$containerPlaceHolder&&t.$containerPlaceHolder.hide()},onEnd:function(e){0===t.datas.length&&t.$containerPlaceHolder.show()}})}new Sortable(document.querySelector(".bsFormContainer"),{group:"shared",animation:150,onAdd:function(e){t._onDragAdd(e)},onEnd:function(e){t._onDragEnd(e)}})},_onDragAdd:function(e){console.log(">>>> onDragAdd: ",e,this);var t=null,n=c(e.item),a=n.attr("data-tag"),a=(a?(t=this.createComponentData(this.components[a]),a=this.render(t,!1),c(e.item).replaceWith(a)):t=this.getDataByElementId(n.attr("id")),this.removeDataByElementId(t.elementId),c(e.to));a.is(".bsFormContainer")?(delete t.parentDataId,delete t.parentDataIndex,this.datas.push(t)):(n=a.closest(".bs-form-item").attr("id"),e=a.closest(".bs-form-container").attr("data-index"),void 0===(n=this.getDataByElementId(n)).children&&(n.children={}),void 0===n.children[e]&&(n.children[""+e]=[]),t.parentDataId=n.id,t.parentDataIndex=e,n.children[e].push(t)),this._invokeComponentOnAdd(t),this.makeFormItemActive(t.elementId),this.refreshDataIndex(a)},_invokeComponentOnAdd:function(e){e.component&&"function"==typeof e.component.onAdd&&e.component.onAdd(this,e)},_onDragEnd:function(e){console.log(">>>> onDragEnd: ",e),this.refreshDataIndex(c(e.from))},createComponentData:function(e){var t=e.onDataCreate&&"function"==typeof e.onDataCreate?e.onDataCreate():{};if(t.elementId=this.genRandomId(),t.id=this.genRandomId(),t.tag=e.tag,t.component=e,t.label||(t.label=e.name),t.name||(t.name=e.tag+"_"+this.componentCounter++),e.props)for(const n of e.props)n.defaultValue&&!t[n.name]&&(t[n.name]=n.defaultValue);return t},genRandomId:function(){for(var e=[],t=0;t<10;t++)e[t]="0123456789abcdef".substr(Math.floor(16*Math.random()),1);return e.join("")},renderDefault:function(t){let n=[];if("object"==typeof t.children)for(var a of Object.keys(t.children)){var i=t.children?t.children[a]:[];let e="";if(i)for(var o of i){o=this.render(o,!1);o&&(e+=o.outerHTML)}n[a]=e}var e=new Proxy(n,{get:function(e,t){return e[t]||""}});let r=t.component.template;var s='let ret=""; ret += "'+r.replace(/\'/g,"&#39;").replace(/\"/g,"&quot;").replace(/[\r\n\t]/g,"").replace(/\{\{~end\}\}/g,'"}"').replace(/\{\{~(.+?)\}\}/g,(e,t)=>'";'+t+'{ ret+="').replace(/\{\{(.+?)\}\}/g,(e,t)=>'"; ret+= '+t+'; ret+="')+'";return ret;',l=this.defaultProps.map(e=>e.name).concat(["value","placeholder"]),l=(t.component.props&&(l=l.concat(t.component.props.map(e=>e.name))),["$builder","$component","$data","$children"].concat(l)),d=l.map(e=>t[e]||"");return d[0]=this,d[1]=t.component,d[2]=t,d[3]=e,new Function(...l,s)(...d).replace(/\&#39;/g,"'").replace(/\&quot;/g,'"')},deepCopy:function(e,t){var n,a=Array.isArray(e)?[]:{};if(e&&"object"==typeof e)for(var i in e)e.hasOwnProperty(i)&&(e[i]&&"object"==typeof e[i]?a[i]=this.deepCopy(e[i],t):(n=e[i],"elementId"!==i&&"id"!==i||(n=this.genRandomId()),a[i]=n));return a},render:function(e,t){var n=e.component,a=null,a="function"==typeof n.template?n.template(n,e):n.render&&"function"==typeof n.render?n.render(this,n,e):this.renderDefault(e),n=c(a).attr("id",e.elementId);return t&&n.append('<div class="bs-item-tools">               <i class="bi bi-card-image bs-item-copy" title="复制"></i>               <i class="bi bi-trash bs-item-del" title="删除"></i>           </div>').addClass("active"),n[0]},makeFormItemActive:function(e){this.currentData&&this.currentData.elementId===e||(this.currentData=this.getDataByElementId(e),this.$container.find(".bs-form-item.active").removeClass("active"),this.$container.find(".bs-item-tools").remove(),c("#"+e).append('<div class="bs-item-tools">               <i class="bi bi-card-image bs-item-copy" title="复制"></i>               <i class="bi bi-trash bs-item-del" title="删除"></i>           </div>').addClass("active"),this.refreshPropsPanel())},deleteFormItem:function(e){this.currentData&&this.currentData.elementId===e&&(this.currentData=null,this.refreshPropsPanel()),this.removeDataByElementId(e),c("#"+e).remove()},copyFormItem:function(e){var t,n,a=this.getDataByElementId(e);a&&(a=this.deepCopy(a,!0),t=this.render(a,!1),(n=c("#"+e)).after(t),this._invokeComponentOnAdd(a),this.getParentArrayByElementId(e).push(a),this.refreshDataIndex(n.parent()))},getDataByElementId:function(e){return this.getDataByElementIdInArray(this.datas,e)},getDataByElementIdInArray:function(e,t){if(!e||0===e.length)return null;for(var n of e){if(n&&n.elementId===t)return n;if(n.children&&"object"==typeof n.children)for(var a of Object.values(n.children)){a=this.getDataByElementIdInArray(a,t);if(a)return a}}return null},removeDataByElementId:function(e){return this.removeDataByElementIdInArray(this.datas,e)},removeDataByElementIdInArray:function(t,n){if(t&&0!==t.length)for(let e=0;e<t.length;e++){var a=t[e];if(a&&a.elementId===n){t.splice(e,1);break}if(a.children&&"object"==typeof a.children)for(var i of Object.values(a.children))this.removeDataByElementIdInArray(i,n)}},getParentArrayByElementId:function(e){return this.getParentArrayByElementIdInArray(this.datas,e)},getParentArrayByElementIdInArray:function(t,n){if(!t||0===t.length)return null;for(let e=0;e<t.length;e++){var a=t[e];if(a&&a.elementId===n)return t;if(a.children&&"object"==typeof a.children)for(var i of Object.values(a.children)){i=this.getParentArrayByElementIdInArray(i,n);if(i)return i}}return null},refreshDataIndex:function(e){var n=this;e.children(".bs-form-item").each(function(e,t){t=c(t).attr("id");n.getDataByElementId(t).index=e})},refreshPropsPanel:function(){if(this.currentData){let e=this.currentData.component;this.$propsPanel.html("");var n,a,i,o,r,s="object"==typeof e.props?e.props:[];let t="function"==typeof e.propsfilter?e.propsfilter(this,this.currentData):"object"==typeof e.propsfilter?e.propsfilter:[];for(n of this.defaultProps.concat(s))s.indexOf(n)<0&&t&&0<t.length&&t.indexOf(n.name)<0||("function"==typeof(i=this.propTemplates[n.type])&&(i=i()),a=this.genRandomId(),(o=(i=c(i)).find(".form-control")).attr("id",a),o.attr("data-attr",n.name),"boolean"==typeof n.disabled&&n.disabled&&o.attr("disabled","true"),n.placeholder&&o.attr("placeholder",n.placeholder),(r=(r=this.currentData[n.name])||void 0===n.defaultValue?r:n.defaultValue)&&("function"==typeof n.onValue?n.onValue(r,this.currentData):o.val(r)),i.find("label").attr("for",a).text(n.label),this.$propsPanel.append(i[0]))}},exportToJson:function(){var e=this.deepCopy(this.datas,!1);return this._arrangeExportData(e),JSON.stringify(e)},_arrangeExportData:function(e){if(e&&0!==e.length){e.sort((e,t)=>e.index-t.index);for(var t of e)if(delete t.component,delete t.elementId,t.children)for(var n of Object.values(t.children))this._arrangeExportData(n)}},getDatas:function(){return this.datas},addDataToRoot:function(e){this.addDatasToRoot([e])},addDatasToRoot:function(e){this._initData(e,!0),this.isBuilderMode()?this._refreshBuilderContainer():this.isViewMode()&&this._refreshViewContainer()},addDataToContainer:function(e,t,n){this.addDatasToContainer([e],t,n)},addDatasToContainer:function(e,t,n){this._initData(e,!1);var a=this.getDataByElementId(t);a?(a.children||(a.children={}),a.children[n]||(a.children[n]=[]),a.children[n].push(...e),this.refreshDataElement(a)):console.error("Can not find data by elementId: "+t)},refreshDataElement:function(e){var t=this.render(e,!0);c("#"+e.elementId).replaceWith(t)},updateDataAttr:function(e,t,n){e?(e[t]=n,e.component&&"function"==typeof e.component.onPropChange&&e.component.onPropChange(this,e,t,n)||this.refreshDataElement(e)):console.error("data must not be null.")},isViewMode:function(){return"view"===this.options.mode},isBuilderMode:function(){return"builder"===this.options.mode}},c.fn.bsFormBuilder=function(n){var a=arguments,i="object"==typeof n&&n;return this.each(function(){var e=c(this),t=e.data("bsFormBuilder");t||e.data("bsFormBuilder",t=new o(this,i)),"string"==typeof n&&((e=t[n])?1<a.length?e.apply(t,Array.prototype.slice.call(a,1)):e():console.error("BsFormBuilder has not the method: "+n))})}}(jQuery);